<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://thumbs.dreamstime.com/z/green-technology-logo-creative-leaf-ecology-tech-nature-vector-nature-symbol-techno-leaf-85937547.jpg?ct=jpeg">
    <title>Remote Terminal</title>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        zinc: {
                            850: '#1f1f22',
                            950: '#09090b',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

        }
        .xterm-viewport::-webkit-scrollbar {
            width: 8px;
        }
        .xterm-viewport::-webkit-scrollbar-track {
            background: #18181b; 
        }
        .xterm-viewport::-webkit-scrollbar-thumb {
            background-color: #3f3f46; 
            border-radius: 4px;
        }
        .active-server-glow {
            box-shadow: 0 0 15px -3px rgba(16, 185, 129, 0.15);
            background-color: rgba(16, 185, 129, 0.03);
            border-left: 2px solid rgba(16, 185, 129, 0.6);
        }
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
        }

        /* Custom Scrollbar for Running Apps & Volumes */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #27272a; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #3f3f46; 
        }
    </style>
</head>

<body class="bg-zinc-950 text-gray-300 font-sans h-screen flex flex-col overflow-hidden selection:bg-indigo-500/30">

    <!-- Top Header (Moved Here - Colab Style) -->
    <div id="top-header"
        class="h-14 bg-zinc-950/50 backdrop-blur border-b border-zinc-800 flex items-center px-4 justify-between shrink-0 z-50 relative">
        <!-- Left: Logo & Title -->
        <div class="flex items-center gap-4">
            <!-- Logo -->
            <div class="p-1.5 bg-orange-600 rounded-full shadow-lg shadow-orange-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
            </div>
            <!-- Title & Menu -->
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-200 tracking-wide">Modal App Manager</span>
                    <span
                        class="text-[10px] bg-zinc-800 text-zinc-400 px-1.5 rounded border border-zinc-700">v2.0</span>
                </div>
                <div class="flex gap-4 text-[11px] text-zinc-500 font-medium mt-0.5">
                    <!-- File Dropdown -->
                    <div class="relative group">
                        <button class="hover:text-zinc-300 transition-colors py-1 cursor-default">File</button>
                        <div class="absolute left-0 top-full mt-1 w-max bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl py-2 px-3 hidden group-hover:block z-50">
                            <span class="text-[10px] text-zinc-400 italic whitespace-nowrap">File not found (404)</span>
                        </div>
                    </div>

                    <!-- Edit Dropdown -->
                    <div class="relative group">
                        <button class="hover:text-zinc-300 transition-colors py-1 cursor-default">Edit</button>
                        <div class="absolute left-0 top-full mt-1 w-max bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl py-2 px-3 hidden group-hover:block z-50">
                            <span class="text-[10px] text-zinc-400 italic whitespace-nowrap">Uneditable reality</span>
                        </div>
                    </div>

                    <!-- Run Dropdown -->
                    <div class="relative group">
                        <button class="hover:text-zinc-300 transition-colors py-1 cursor-default">Run</button>
                        <div class="absolute left-0 top-full mt-1 w-max bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl py-2 px-3 hidden group-hover:block z-50">
                            <span class="text-[10px] text-zinc-400 italic whitespace-nowrap">Run for your life!</span>
                        </div>
                    </div>

                    <!-- Help Dropdown -->
                    <div class="relative group">
                        <button class="hover:text-zinc-300 transition-colors py-1 cursor-default">Help</button>
                        <div class="absolute right-0 top-full mt-1 w-max bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl py-2 px-3 hidden group-hover:block z-50">
                            <span class="text-[10px] text-zinc-400 italic whitespace-nowrap">help yourself</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Controls -->
        <div class="flex items-center gap-3">
            <!-- RAM/Disk Status (Mock) -->
            <div
                class="hidden lg:flex items-center gap-3 px-4 py-1.5 bg-zinc-900/50 rounded-full border border-zinc-800/50 text-[10px] text-zinc-400">
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></span>
                    <span>RAM 12.7 GB</span>
                </div>
                <span class="w-px h-3 bg-zinc-800"></span>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.5)]"></span>
                    <span>Disk 80.2 GB</span>
                </div>
            </div>

            <!-- Connect/Share -->
            <button
                class="hidden sm:flex px-4 py-1.5 bg-blue-600/90 hover:bg-blue-600 text-white text-xs font-semibold rounded-full transition-all shadow-lg shadow-blue-900/20 items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                Share
            </button>

            <!-- Profile Dropdown (Header) -->
            <div class="relative">
                <button onclick="toggleProfileMenu()"
                    class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-zinc-800 transition-colors border border-transparent hover:border-zinc-700 outline-none">
                    <img src="{{ current_user.avatar_url }}" alt="Avatar"
                        class="w-7 h-7 rounded-full bg-zinc-700 object-cover ring-2 ring-zinc-900">
                    <span class="hidden md:block text-xs font-semibold text-zinc-300">{{ current_user.username }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-zinc-500">
                        <path d="m6 9 6 6 6-6" />
                    </svg>
                </button>

                <!-- Dropdown Menu -->
                <div id="profile-menu"
                    class="hidden absolute right-0 mt-2 w-48 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 overflow-hidden">
                    <div class="px-4 py-3 border-b border-zinc-800">
                        <p class="text-[10px] text-zinc-500 uppercase tracking-wider">Signed in as</p>
                        <p class="text-sm font-medium text-white truncate">{{ current_user.username }}</p>
                    </div>
                    <div class="py-1">
                        <button onclick="openProfileModal()"
                            class="w-full text-left px-4 py-2 text-sm text-zinc-400 hover:bg-zinc-800 hover:text-white transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Profile
                        </button>
                        <button onclick="openLogoutModal()"
                            class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Wrapper (Sidebar + Main) -->
    <div id="content-wrapper" class="flex flex-1 overflow-hidden relative">

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="closeMobileSidebar()"
            class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 hidden transition-opacity duration-300 opacity-0">
        </div>

        <!-- Sidebar -->
        <!-- Sidebar Container (Floating Style) -->
        <div id="left-panel-container"
            class="contents md:flex md:relative md:z-20 md:p-3 md:gap-3 md:pointer-events-auto">

            <!-- 1. Icon Bar (Bottom on Mobile, Left on Desktop) -->
            <div id="icon-bar"
                class="fixed bottom-0 left-0 w-full h-16 z-50 bg-zinc-950/90 backdrop-blur-md border-t border-zinc-800 flex flex-row items-center justify-around pointer-events-auto md:relative md:top-auto md:bottom-auto md:w-14 md:h-full md:flex-col md:justify-start md:border md:rounded-2xl md:py-4 md:gap-4 md:shadow-2xl">

                <!-- Home Icon -->
                <button onclick="goHome()" id="btn-home"
                    class="md:hidden p-3 rounded-xl hover:bg-zinc-800 text-zinc-400 hover:text-white transition-all duration-300 sidebar-icon hover:scale-105 active:scale-95"
                    title="Home (VM Manager)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </button>
                <!-- Remote Terminal Icon -->
                <button onclick="toggleSidePanel('remote-terminal')" id="btn-remote-terminal"
                    class="p-3 rounded-xl hover:bg-zinc-800 text-zinc-400 hover:text-white transition-all duration-300 sidebar-icon active-icon hover:scale-105 active:scale-95"
                    title="Remote Terminal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                </button>
                <!-- Code Editor Icon -->
                <button onclick="toggleSidePanel('code-editor')" id="btn-code-editor"
                    class="p-3 rounded-xl hover:bg-zinc-800 text-zinc-400 hover:text-white transition-all duration-300 sidebar-icon hover:scale-105 active:scale-95"
                    title="Code Editor">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" 
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </button>

            </div>

            <!-- 2. Side Panel (Drawer on Mobile, Next to Bar on Desktop) -->
            <div id="side-panel"
                class="fixed top-14 bottom-16 left-0 z-40 bg-zinc-900/95 backdrop-blur-md border-r border-zinc-800 shadow-2xl transition-all duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1.0)] overflow-hidden w-0 opacity-0 pointer-events-auto flex flex-col md:relative md:inset-auto md:h-full md:border md:rounded-2xl"
                style="min-width: 0;">

                <!-- Header -->
                <div
                    class="h-14 px-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50 backdrop-blur shrink-0">
                    <div id="sidebar-title"
                        class="flex items-center gap-2 overflow-hidden whitespace-nowrap transition-opacity duration-200">
                        <div
                            class="w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)] shrink-0">
                        </div>
                        <!-- Dynamic Title -->
                        <span id="panel-header-text" class="font-bold text-gray-100 tracking-wide text-sm">REMOTE
                            TERMINAL</span>
                    </div>
                    <!-- Close Button -->
                    <button onclick="closeSidePanel()"
                        class="p-1.5 rounded-md text-gray-400 hover:text-white hover:bg-zinc-800 transition-colors z-30">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content Area Stack -->
                <div class="flex-1 overflow-hidden relative">

                    <!-- CONTENT 1: Remote Terminal -->
                    <div id="content-remote-terminal" class="absolute inset-0 flex flex-col panel-content">
                        <!-- Add Button -->
                        <div id="add-worker-container"
                            class="px-2 py-2 flex justify-center border-b border-zinc-800/50 shrink-0">
                            <button id="add-worker-btn"
                                class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-zinc-800/50 text-gray-400 hover:text-white hover:bg-zinc-800 transition-all group/add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span class="text-xs font-medium sidebar-text">Add Worker</span>
                            </button>
                        </div>

                        <!-- Worker List -->
                        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar overflow-x-hidden">
                            <div
                                class="text-xs font-semibold text-zinc-500 mb-2 px-2 uppercase tracking-wider sidebar-text whitespace-nowrap">
                                Connected Workers</div>
                            <ul id="worker-list" class="space-y-1">
                                <!-- Worker items injected here -->
                            </ul>
                        </div>

                        <!-- Footer -->
                        <div
                            class="p-3 border-t border-zinc-800 text-xs text-zinc-600 text-center shrink-0 sidebar-text whitespace-nowrap overflow-hidden">
                            v2.0.0 • Connected
                        </div>
                    </div>

                    <!-- CONTENT 2: Code Editor -->
                    <div id="content-code-editor" class="absolute inset-0 flex flex-col p-0 hidden panel-content">
                        <div class="p-3 border-b border-zinc-800 bg-zinc-900/50">
                             <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider flex justify-between items-center mb-2">
                                 <span>Explorer</span>
                                  <button onclick="fetchFiles(currentExplorerPath)" class="text-zinc-400 hover:text-white" title="Refresh">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                  </button>
                             </h3>
                             <div class="flex gap-1">
                                 <button onclick="createNewItem('file')" class="flex-1 flex items-center justify-center gap-1.5 px-2 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded text-xs transition-colors border border-zinc-700">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                                     Run App (File)
                                 </button>
                                 <button onclick="createNewItem('directory')" class="flex-1 flex items-center justify-center gap-1.5 px-2 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded text-xs transition-colors border border-zinc-700">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                                     Folder
                                 </button>
                             </div>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar">
                            <ul id="file-list" class="space-y-0.5 p-2">
                                <!-- File items injected here -->
                                <li class="text-center text-zinc-600 text-xs py-4">Loading...</li>
                            </ul>
                        </div>
                    </div>



                </div>
            </div>

            <!-- Resize Handle -->
            <div id="resize-handle"
                class="w-1 cursor-col-resize hover:bg-emerald-500/50 active:bg-emerald-500 bg-transparent absolute right-0 top-0 bottom-0 z-50 transition-colors hidden md:block"
                style="right: -4px;">
            </div>
        </div>

        <!-- Sidebar Toggle Logic -->
        <script>
            const sidePanel = document.getElementById('side-panel');
            const panelHeaderText = document.getElementById('panel-header-text');

            // Active mode state
            let currentMode = null; // 'remote-terminal' or 'new-menu' or null (closed)

            function toggleSidePanel(mode) {
                const isClosed = sidePanel.classList.contains('w-0');
                const mobileOverlay = document.getElementById('mobile-overlay');

                // 1. If clicking same mode while open -> Close it
                if (!isClosed && currentMode === mode) {
                    closeSidePanel();
                    return;
                }

                // 2. Open or Switch mode
                // Update Content Visibility
                document.querySelectorAll('.panel-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`content-${mode}`).classList.remove('hidden');

                // Update Header Text
                if (mode === 'remote-terminal') {
                    panelHeaderText.textContent = 'REMOTE TERMINAL';
                } else if (mode === 'code-editor') {
                    panelHeaderText.textContent = 'CODE EDITOR';
                } else if (mode === 'new-menu') {
                    panelHeaderText.textContent = 'MENU BARU';
                }

                // Update Icon Highlights
                document.querySelectorAll('.sidebar-icon').forEach(icon => {
                    icon.classList.remove('text-white', 'bg-zinc-800');
                    icon.classList.add('text-zinc-400');
                });
                const activeBtn = document.getElementById(`btn-${mode}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-zinc-400');
                    activeBtn.classList.add('text-white', 'bg-zinc-800');
                }

                // Animation: Expand Width and Opacity
                sidePanel.classList.remove('w-0', 'border-0', 'p-0', 'opacity-0');
                sidePanel.classList.add('w-72', 'opacity-100');

                // Show Overlay on Mobile
                if (window.innerWidth < 768) {
                    mobileOverlay.classList.remove('hidden');
                    setTimeout(() => mobileOverlay.classList.remove('opacity-0'), 10);
                }

                currentMode = mode;
            }

            function closeSidePanel() {
                const mobileOverlay = document.getElementById('mobile-overlay');

                // Hide Panel (Collapse Width)
                sidePanel.classList.remove('w-72', 'opacity-100');
                sidePanel.classList.add('w-0', 'border-0', 'p-0', 'opacity-0');
                currentMode = null;

                // Hide Overlay
                mobileOverlay.classList.add('opacity-0');
                setTimeout(() => mobileOverlay.classList.add('hidden'), 300);

                // Reset icons
                document.querySelectorAll('.sidebar-icon').forEach(icon => {
                    icon.classList.remove('text-white', 'bg-zinc-800');
                    icon.classList.add('text-zinc-400');
                });
            }


            // Mobile Overlay Helper
            function closeMobileSidebar() {
                closeSidePanel();
            }

            // Cleanup on Resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    const mobileOverlay = document.getElementById('mobile-overlay');
                    if (!mobileOverlay.classList.contains('hidden')) {
                        mobileOverlay.classList.add('hidden', 'opacity-0');
                    }
                }
            });
        </script>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 flex flex-col min-w-0 bg-black relative">

            <!-- Empty State -->
            <div id="empty-state"
                class="absolute inset-0 flex flex-col items-center justify-center text-zinc-600 animate-fade-in z-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                    class="mb-4 opacity-20">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                <h2 class="text-xl font-medium text-zinc-500 mb-2">No Worker Selected</h2>
                <p class="text-sm">Select a worker from the sidebar to start a session.</p>
            </div>

            <!-- Page 1 Container (Dummy) -->
            <div id="main-page-1" class="hidden absolute inset-0 bg-zinc-950 z-20 flex flex-col items-center justify-center animate-fade-in">
                <div
                    class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500">
                    ini adalah main menu page1
                </div>
            </div>

            <!-- Editor Container -->
            <div id="editor-container" class="hidden absolute inset-0 flex-col bg-zinc-900 z-30">
                <!-- Toolbar -->
                <div class="h-12 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between px-4 shrink-0">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span id="editor-filename" class="text-sm font-medium text-white truncate max-w-[200px] md:max-w-md">No File Selected</span>
                        <span id="editor-status" class="text-xs text-zinc-500 font-medium px-2 py-0.5 rounded border border-zinc-700">Read Only</span>
                        <span id="editor-unsaved" class="text-xs text-amber-500 font-medium hidden">● Unsaved</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Navbar Cursor Controls -->
                        <div class="flex items-center gap-1 mr-1">
                            <button onclick="editorMove('left')" class="p-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors border border-zinc-700" title="Left">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            </button>
                            <button onclick="editorMove('down')" class="p-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors border border-zinc-700" title="Down">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                            </button>
                            <button onclick="editorMove('up')" class="p-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors border border-zinc-700" title="Up">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
                            </button>
                            <button onclick="editorMove('right')" class="p-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors border border-zinc-700" title="Right">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                        </div>
                        <button id="btn-edit-file" onclick="enableEditing()" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 hover:text-white text-xs font-medium rounded transition-colors flex items-center gap-1 border border-zinc-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Edit
                        </button>
                        <button id="btn-save-file" onclick="saveFile()" class="hidden px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-medium rounded transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save
                        </button>
                        <button onclick="closeEditor()" class="p-1.5 text-zinc-400 hover:text-white bg-zinc-800 hover:bg-zinc-700 rounded transition-colors" title="Close">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <!-- Ace Editor Container -->
                <div id="file-editor" class="flex-1 w-full h-full text-base"></div>
            </div>

            <!-- Terminal Containers injected here -->

            <!-- Web UI Container -->
            <div id="web-ui-container"
                class="hidden absolute inset-0 bg-zinc-950 z-20 flex flex-col items-center justify-start pt-4 animate-fade-in p-2 md:p-4">
                <div
                    class="w-full h-full md:max-w-6xl md:h-[750px] md:max-h-[90vh] md:rounded-2xl md:border md:border-zinc-800 bg-zinc-900/95 backdrop-blur-sm p-4 pb-24 md:p-6 flex flex-col overflow-y-auto md:overflow-hidden">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                            <span id="vm-logo-indicator" class="text-zinc-500 transition-all duration-500 ease-in-out cursor-help" title="Cloudflare Tunnel: Inactive">❖</span> VM Manager
                        </h1>
                    </div>

                    <!-- Profile Toolbar & Actions -->
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3 shrink-0 flex-wrap">
                        <!-- Current Profile -->
                        <div class="flex items-center gap-3 bg-zinc-950/50 border border-zinc-800 rounded-lg p-2 pr-4 min-w-0 flex-1 md:flex-initial overflow-hidden">
                            <div class="h-8 w-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] text-zinc-500 uppercase tracking-wider font-bold">Profile</span>
                                <div class="flex items-center gap-2">
                                    <span id="current-profile-name" onclick="fetchModalProfiles()"
                                        class="text-sm font-medium text-white cursor-pointer hover:text-emerald-400 transition-colors"
                                        title="Click to Switch Profile">Loading...</span>
                                    <!-- Balance Display -->
                                    <span id="profile-balance"
                                        class="hidden ml-2 text-xs font-mono text-emerald-400 bg-emerald-400/10 px-1.5 py-0.5 rounded border border-emerald-400/20 items-center gap-1 group">
                                        <span id="balance-value">...</span>
                                        <button onclick="fetchProfileBalance(true)"
                                            class="text-emerald-500 hover:text-emerald-300 transition-colors"
                                            title="Refresh Balance">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="transform group-hover:rotate-180 transition-transform duration-500">
                                                <path
                                                    d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
                                            </svg>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2 w-full md:w-auto">



                            <!-- Terminal Button -->
                            <button onclick="showWorkerTerminal(event, activeWorkerId)"
                                class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded-lg transition-colors border border-zinc-700 flex items-center justify-center gap-2"
                                title="Terminal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="4 17 10 11 4 5"></polyline>
                                    <line x1="12" y1="19" x2="20" y2="19"></line>
                                </svg>
                                <span class="hidden lg:inline text-xs font-medium">Terminal</span>
                            </button>

                            <!-- Wallet Logs Button -->
                            <button onclick="openWalletLogs()" id="wallet-logs-btn"
                                class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded-lg transition-colors border border-zinc-700 flex items-center justify-center gap-2"
                                title="Wallet Logs">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                <span class="hidden lg:inline text-xs font-medium">Logs</span>
                            </button>


                            <div class="relative">
                                <button onclick="toggleStartMenu()" id="start-server-btn"
                                    class="px-3 md:px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs md:text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20 flex items-center gap-2 flex-1 md:flex-none justify-center whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Start Server
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 opacity-70"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </button>
                                <!-- Dropdown Menu -->
                                <div id="start-menu-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-zinc-800 border border-zinc-700 rounded-lg shadow-xl z-50 overflow-hidden transform transition-all origin-top-right">
                                    <button onclick="openConfigModal()" class="w-full text-left px-4 py-3 text-zinc-300 hover:bg-zinc-700/50 hover:text-white transition-colors flex items-center gap-2 group">
                                        <svg class="text-zinc-500 group-hover:text-emerald-400" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        <div>
                                            <div class="text-xs font-medium">Configuration</div>
                                            <div class="text-[10px] text-zinc-500">Edit Server Settings</div>
                                        </div>
                                    </button>
                                    <div class="border-t border-zinc-700/50"></div>
                                    <button onclick="handleStartOption('standard')" class="w-full text-left px-4 py-3 text-zinc-300 hover:bg-zinc-700/50 hover:text-white transition-colors flex items-center gap-2 group">
                                        <svg class="text-zinc-500 group-hover:text-emerald-400" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
                                        <div>
                                            <div class="text-xs font-medium">Standard Start</div>
                                            <div class="text-[10px] text-zinc-500">Run in background (Normal)</div>
                                        </div>
                                    </button>
                                    <div class="border-t border-zinc-700/50"></div>
                                    <button onclick="handleStartOption('terminal')" class="w-full text-left px-4 py-3 text-zinc-300 hover:bg-zinc-700/50 hover:text-white transition-colors flex items-center gap-2 group">
                                        <svg class="text-zinc-500 group-hover:text-emerald-400" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                                        <div>
                                            <div class="text-xs font-medium">Terminal Start</div>
                                            <div class="text-[10px] text-zinc-500">Run & View in Terminal</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Apps and Volumes Grid -->
                    <div class="flex-1 flex flex-col md:flex-row gap-4 min-h-0 overflow-hidden">
                        
                        <!-- Running Apps Table -->
                        <div class="flex-1 flex flex-col min-h-0 bg-zinc-950/50 rounded-xl border border-zinc-800 overflow-hidden">
                             <div class="flex justify-between items-center p-3 border-b border-zinc-800 bg-zinc-900/30">
                                <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Running Apps</h2>
                                <button onclick="fetchModalApps()" class="p-1.5 text-zinc-400 hover:text-white rounded hover:bg-zinc-800 transition-colors" title="Refresh List">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                </button>
                            </div>
                            <div class="flex-1 overflow-auto custom-scrollbar">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-zinc-900/50 sticky top-0 z-10 text-xs text-zinc-500 uppercase font-medium">
                                        <tr>
                                            <th class="p-3 font-medium border-b border-zinc-800">App Name</th>
                                            <th class="p-3 font-medium border-b border-zinc-800">Create / Stop</th>
                                            <th class="p-3 font-medium border-b border-zinc-800 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modal-app-list" class="text-sm text-zinc-300 font-mono divide-y divide-zinc-800/50"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Volumes Table -->
                        <div class="flex-1 flex flex-col min-h-0 bg-zinc-950/50 rounded-xl border border-zinc-800 overflow-hidden">
                             <div class="flex justify-between items-center p-3 border-b border-zinc-800 bg-zinc-900/30">
                                <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Volumes</h2>
                                <div class="flex gap-1">
                                    <button onclick="openCreateVolumeModal()" class="p-1.5 text-zinc-400 hover:text-white rounded hover:bg-zinc-800 transition-colors" title="Create Volume">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    </button>
                                    <button onclick="fetchModalVolumes()" class="p-1.5 text-zinc-400 hover:text-white rounded hover:bg-zinc-800 transition-colors" title="Refresh Volumes">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-auto custom-scrollbar">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-zinc-900/50 sticky top-0 z-10 text-xs text-zinc-500 uppercase font-medium">
                                            <th class="p-3 font-medium border-b border-zinc-800">Name</th>
                                            <th class="p-3 font-medium border-b border-zinc-800">Created At</th>
                                            <th class="p-3 font-medium border-b border-zinc-800">Created By</th>
                                            <th class="p-3 font-medium border-b border-zinc-800 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modal-volume-list" class="text-sm text-zinc-300 font-mono divide-y divide-zinc-800/50"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Add Worker Modal -->
        <div id="modal-overlay"
            class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-all duration-300">
            <div
                class="bg-zinc-900/90 backdrop-blur-sm border border-zinc-800 w-full max-w-md rounded-xl p-6 shadow-2xl transform transition-all scale-100 ring-1 ring-white/10 animate-fade-in">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-emerald-500">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Connect New Worker
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Worker
                            URL</label>
                        <div class="relative">
                            <input type="text" id="worker-url-input" placeholder="e.g. http://localhost:5001"
                                value="http://localhost:5001"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2.5 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all placeholder-zinc-600 font-mono">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Name
                                (Optional)</label>
                            <input type="text" id="worker-name-input" placeholder="My Server"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2.5 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all placeholder-zinc-600">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Token</label>
                            <input type="password" id="worker-token-input" placeholder="••••••••"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2.5 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all placeholder-zinc-600">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button onclick="closeModal()"
                        class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">Cancel</button>
                    <button onclick="connectWorker()"
                        class="px-6 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 rounded-lg shadow-lg shadow-emerald-900/20 transition-all duration-200 flex items-center gap-2">
                        Connect
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal (Can be similarly styled, stripped down for brevity based on plan) -->
        <div id="settings-modal"
            class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
            <div
                class="bg-zinc-900/90 backdrop-blur-sm border border-zinc-800 w-full max-w-md rounded-xl p-6 shadow-2xl ring-1 ring-white/10 animate-fade-in">
                <h3 class="text-lg font-semibold text-white mb-6">Worker Settings</h3>
                <input type="hidden" id="edit-worker-id">

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5">Name</label>
                        <input type="text" id="edit-worker-name"
                            class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5">URL</label>
                        <input type="text" id="edit-worker-url"
                            class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5">Token Loopdate</label>
                        <input type="password" id="edit-worker-token" placeholder="Unchanged"
                            class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-sm focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button onclick="deleteWorkerFromModal()"
                        class="text-red-400 hover:text-red-300 text-sm font-medium px-2 py-1 hover:bg-red-900/20 rounded transition-colors">Remove
                        Worker</button>
                    <div class="flex gap-3">
                        <button onclick="closeSettingsModal()"
                            class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white">Cancel</button>
                        <button onclick="saveSettings()"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-lg shadow-lg">Save
                            Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const socket = io();
            let activeWorkerId = null;
            let localWorkerId = null;

            // Cloudflare Tunnel Status
            socket.on('connect', function() {
                socket.emit('get_tunnel_status');
            });

            socket.on('tunnel_status', function(data) {
                const el = document.getElementById('vm-logo-indicator');
                if (data.active) {
                    el.className = 'text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.8)] transition-all duration-500 ease-in-out cursor-help';
                    el.title = "Cloudflare Tunnel: ACTIVE";
                } else {
                    el.className = 'text-zinc-600 transition-all duration-500 ease-in-out cursor-help';
                    el.title = "Cloudflare Tunnel: Inactive";
                }
            });

            // UI Elements
            const workerList = document.getElementById('worker-list');
            const mainContent = document.getElementById('main-content');
            const emptyState = document.getElementById('empty-state');
            const modal = document.getElementById('modal-overlay');
            const urlInput = document.getElementById('worker-url-input');
            const nameInput = document.getElementById('worker-name-input');
            const tokenInput = document.getElementById('worker-token-input');

            const settingsModal = document.getElementById('settings-modal');
            const editIdInput = document.getElementById('edit-worker-id');
            const editNameInput = document.getElementById('edit-worker-name');
            const editUrlInput = document.getElementById('edit-worker-url');
            const editTokenInput = document.getElementById('edit-worker-token');

            // Sidebar Logic
            const sidebar = document.getElementById('sidebar');
            const resizeHandle = document.getElementById('resize-handle');
            const sidebarTitle = document.getElementById('sidebar-title');
            let isResizing = false;
            let isCollapsed = false;
            let lastWidth = 288; // default w-72

            function toggleSidebar() {
                isCollapsed = !isCollapsed;
                if (isCollapsed) {
                    lastWidth = sidebar.offsetWidth;
                    sidebar.style.width = '64px'; // w-16
                    document.querySelectorAll('.sidebar-text').forEach(el => el.style.opacity = '0');
                    sidebarTitle.style.opacity = '0';
                    // Adjust Add Worker button for collapsed state
                    document.getElementById('add-worker-btn').classList.add('px-0');
                } else {
                    sidebar.style.width = lastWidth + 'px';
                    // Delay text appearance for smooth transition
                    setTimeout(() => {
                        document.querySelectorAll('.sidebar-text').forEach(el => el.style.opacity = '1');
                        sidebarTitle.style.opacity = '1';
                    }, 150);
                    document.getElementById('add-worker-btn').classList.remove('px-0');
                }
                // Trigger resize for terminals
                setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            }

            // Resizing Logic
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                sidebar.style.transition = 'none'; // Disable transition during drag
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                // Min 64px, Max 600px
                let newWidth = Math.max(64, Math.min(600, e.clientX));

                // Auto collapse if too small
                if (newWidth < 100) {
                    if (!isCollapsed) toggleSidebar();
                    return;
                } else if (isCollapsed) {
                    toggleSidebar(); // Expand if dragged out
                }

                sidebar.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                    sidebar.style.transition = 'all 0.3s ease-in-out';
                    lastWidth = sidebar.offsetWidth;
                    // Trigger resize for terminals
                    window.dispatchEvent(new Event('resize'));
                }
            });

            // Modal Logic
            document.getElementById('add-worker-btn').addEventListener('click', () => {
                modal.classList.remove('hidden');
                nameInput.focus();
            });

            function closeModal() {
                modal.classList.add('hidden');
            }

            function connectWorker() {
                const url = urlInput.value.trim();
                const name = nameInput.value.trim();
                const token = tokenInput.value.trim();
                if (url) {
                    socket.emit('add_worker', { url: url, name: name, token: token });
                    closeModal();
                    urlInput.value = 'http://localhost:5001';
                    nameInput.value = '';
                    tokenInput.value = '';
                }
            }

            // --- Terminal Logic ---
            const terminalStates = {};
            const activeSessions = {};
            const closedSessions = new Set();

            class TerminalRenderer {
                constructor(workerId, sessionId) {
                    this.workerId = workerId;
                    this.sessionId = sessionId;
                    this.outputDiv = document.getElementById(`output-${workerId}-${sessionId}`);

                    // VS Code Dark Theme Colors
                    this.term = new Terminal({
                        cursorBlink: true,
                        cursorStyle: 'bar',
                        fontSize: 14,
                        fontFamily: '"JetBrains Mono", Menlo, Consolas, monospace',
                        theme: {
                            background: '#09090b', // zinc-950
                            foreground: '#d4d4d8', // zinc-300
                            cursor: '#22d3ee', // cyan-400
                            selectionBackground: 'rgba(99, 102, 241, 0.3)',
                            black: '#000000',
                            red: '#ef4444',
                            green: '#22c55e',
                            yellow: '#eab308',
                            blue: '#3b82f6',
                            magenta: '#d946ef',
                            cyan: '#06b6d4',
                            white: '#f4f4f5',
                            brightBlack: '#71717a',
                            brightRed: '#f87171',
                            brightGreen: '#4ade80',
                            brightYellow: '#facc15',
                            brightBlue: '#60a5fa',
                            brightMagenta: '#e879f9',
                            brightCyan: '#22d3ee',
                            brightWhite: '#ffffff'
                        },
                        allowTransparency: true
                    });

                    this.fitAddon = new FitAddon.FitAddon();
                    this.term.loadAddon(this.fitAddon);

                    this.term.open(this.outputDiv);
                    this.fitAddon.fit();

                    this.term.onData(data => {
                        socket.emit('term_input', {
                            worker_id: this.workerId,
                            session_id: this.sessionId,
                            input: data
                        });
                    });

                    window.addEventListener('resize', () => this.fit());
                    setTimeout(() => this.fit(), 50);
                }

                fit() {
                    try {
                        this.fitAddon.fit();
                        const dims = { cols: this.term.cols, rows: this.term.rows };
                        socket.emit('resize', {
                            worker_id: this.workerId,
                            session_id: this.sessionId,
                            cols: dims.cols,
                            rows: dims.rows
                        });
                    } catch (e) {
                        console.error("Fit error", e);
                    }
                }

                process(text) {
                    this.term.write(text);
                }

                clear() {
                    this.term.clear();
                }
            }

            // Layout Generators with Tailwind
            function createTerminalUI(workerId) {
                // Outer Wrapper (Matches Web UI Container)
                const wrapper = document.createElement('div');
                wrapper.id = `term-wrapper-${workerId}`;
                wrapper.className = 'terminal-wrapper hidden absolute inset-0 bg-zinc-950 z-10 flex flex-col items-center justify-start pt-4 animate-fade-in p-2 md:p-4';

                // Inner Card (Matches Web UI Card)
                const card = document.createElement('div');
                card.className = 'w-full h-full md:max-w-6xl md:h-[750px] md:max-h-[90vh] md:rounded-2xl md:border md:border-zinc-800 bg-zinc-900/95 backdrop-blur-sm flex flex-col overflow-hidden';

                card.innerHTML = `
                <!-- Tabs Header -->
                <div class="h-10 bg-zinc-900 border-b border-zinc-800 flex items-center pr-2 select-none shrink-0">
                    <button class="w-8 h-8 flex items-center justify-center text-zinc-500 hover:text-white hover:bg-zinc-800 rounded transition-colors mr-1 ml-2" onclick="goHome()" title="Back to VM Manager">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    </button>
                    <div class="flex-1 flex overflow-x-auto scrollbar-hide" id="tabs-list-${workerId}">
                        <!-- Tabs injected here -->
                    </div>
                    <button class="w-8 h-8 flex items-center justify-center text-zinc-500 hover:text-white hover:bg-zinc-800 rounded transition-colors ml-1" onclick="createNewSession('${workerId}')" title="New Session">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                
                <!-- Content Area -->
                <div id="tabs-content-${workerId}" class="flex-1 relative flex flex-col min-h-0">
                    <!-- Tab contents injected here -->
                </div>
                `;

                wrapper.appendChild(card);
                mainContent.appendChild(wrapper);

                terminalStates[workerId] = { wrapper: wrapper }; // Store wrapper ref
                createNewSession(workerId, 'session-1');
            }

            function createNewSession(workerId, requestedSessionId = null) {
                const sessionId = requestedSessionId || 'sess-' + Math.random().toString(36).substr(2, 9);
                socket.emit('create_session', { worker_id: workerId, session_id: sessionId });
                addTabUI(workerId, sessionId);
            }

            function addTabUI(workerId, sessionId) {
                const tabsList = document.getElementById(`tabs-list-${workerId}`);
                const tabsContent = document.getElementById(`tabs-content-${workerId}`);

                // Tab Button (Browser Style: Rounded + Draggable)
                const tabBtn = document.createElement('div');
                // Added rounded-t-lg and mr-1 for spacing
                tabBtn.className = 'tab-btn group flex items-center gap-2 px-3 py-2.5 h-10 min-w-[120px] max-w-[200px] text-xs border-r border-zinc-800 bg-zinc-900 text-zinc-500 cursor-pointer hover:bg-zinc-800 hover:text-zinc-300 transition-colors border-t-2 border-t-transparent rounded-t-lg mr-1';
                tabBtn.id = `tab-btn-${workerId}-${sessionId}`;
                tabBtn.setAttribute('draggable', 'true'); // Enable Dragging

                // Drag Events
                tabBtn.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({ workerId, sessionId }));
                    e.dataTransfer.effectAllowed = 'move';
                    tabBtn.classList.add('opacity-50'); // Visual feedback
                };

                // Context Menu
                tabBtn.oncontextmenu = (e) => showTabContextMenu(e, workerId, sessionId);

                tabBtn.ondragend = () => {
                    tabBtn.classList.remove('opacity-50');
                };
                tabBtn.ondragover = (e) => {
                    e.preventDefault(); // Allow dropping
                    e.dataTransfer.dropEffect = 'move';
                    tabBtn.classList.add('bg-zinc-800'); // Highlight drop target
                };
                tabBtn.ondragleave = () => {
                    tabBtn.classList.remove('bg-zinc-800');
                    // Restore active/inactive bg if needed, simplified for now
                    if (activeSessions[workerId] === sessionId) {
                        tabBtn.classList.add('bg-zinc-950');
                    } else {
                        tabBtn.classList.add('bg-zinc-900');
                    }
                };
                tabBtn.ondrop = (e) => {
                    e.preventDefault();
                    tabBtn.classList.remove('bg-zinc-800'); // Remove highlight

                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (data.workerId !== workerId) return; // Only reorder within same worker

                    const sourceId = `tab-btn-${data.workerId}-${data.sessionId}`;
                    const targetId = `tab-btn-${workerId}-${sessionId}`;

                    const sourceBtn = document.getElementById(sourceId);
                    const targetBtn = document.getElementById(targetId);
                    const list = document.getElementById(`tabs-list-${workerId}`);

                    // Reorder logic: Insert source before target, or after if dragging right?
                    // Simple swap or insertBefore is standard
                    // Let's implement robust "insert at index" logic or simple node move
                    // If dropping ON a tab, put it before that tab?

                    // Simple logic: Insert source before target
                    if (sourceBtn && targetBtn && sourceBtn !== targetBtn) {
                        const children = Array.from(list.children);
                        const sourceIndex = children.indexOf(sourceBtn);
                        const targetIndex = children.indexOf(targetBtn);

                        if (sourceIndex < targetIndex) {
                            list.insertBefore(sourceBtn, targetBtn.nextSibling);
                        } else {
                            list.insertBefore(sourceBtn, targetBtn);
                        }
                    }

                    // Restore styles
                    if (activeSessions[workerId] === sessionId) tabBtn.classList.add('bg-zinc-950');
                    else tabBtn.classList.add('bg-zinc-900');
                };

                tabBtn.innerHTML = `
                <div class="flex-1 truncate font-medium">Terminal</div>
                <div class="opacity-0 group-hover:opacity-100 p-0.5 rounded-sm hover:bg-zinc-700 text-zinc-400 hover:text-white transition-opacity" onclick="closeSession(event, '${workerId}', '${sessionId}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            `;
                tabBtn.onclick = () => switchTab(workerId, sessionId);
                tabsList.appendChild(tabBtn);

                // Tab Content
                const contentDiv = document.createElement('div');
                contentDiv.className = 'tab-content hidden absolute inset-0 flex-col'; // H-full w-full
                contentDiv.id = `tab-content-${workerId}-${sessionId}`;
                contentDiv.innerHTML = `
                <div class="terminal-output flex-1 w-full bg-zinc-950 p-1" id="output-${workerId}-${sessionId}"></div>
            `;
                tabsContent.appendChild(contentDiv);

                if (!terminalStates[workerId]) terminalStates[workerId] = {};
                terminalStates[workerId][sessionId] = new TerminalRenderer(workerId, sessionId);

                switchTab(workerId, sessionId);
            }

            function switchTab(workerId, sessionId) {
                activeSessions[workerId] = sessionId;

                // Update Tabs Styling
                const buttons = document.querySelectorAll(`#tabs-list-${workerId} .tab-btn`);
                buttons.forEach(btn => {
                    // Inactive
                    btn.classList.remove('bg-zinc-950', 'text-white', 'border-t-emerald-500');
                    btn.classList.add('bg-zinc-900', 'text-zinc-500', 'border-t-transparent');
                });
                const activeBtn = document.getElementById(`tab-btn-${workerId}-${sessionId}`);
                if (activeBtn) {
                    // Active
                    activeBtn.classList.remove('bg-zinc-900', 'text-zinc-500', 'border-t-transparent');
                    activeBtn.classList.add('bg-zinc-950', 'text-white', 'border-t-emerald-500');
                }

                // Update Content Visibility
                const contents = document.querySelectorAll(`#tabs-content-${workerId} .tab-content`);
                contents.forEach(content => content.classList.add('hidden'));
                const activeContent = document.getElementById(`tab-content-${workerId}-${sessionId}`);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                    activeContent.classList.add('flex');

                    // Refit
                    if (terminalStates[workerId] && terminalStates[workerId][sessionId]) {
                        setTimeout(() => {
                            terminalStates[workerId][sessionId].fit();
                            terminalStates[workerId][sessionId].term.focus();
                        }, 50);
                    }
                }
            }

            function closeSession(e, workerId, sessionId) {
                e.stopPropagation();
                // Optional: confirm('Close tab?')
                closedSessions.add(`${workerId}-${sessionId}`);

                const btn = document.getElementById(`tab-btn-${workerId}-${sessionId}`);
                const content = document.getElementById(`tab-content-${workerId}-${sessionId}`);
                if (btn) btn.remove();
                if (content) content.remove();

                if (terminalStates[workerId]) delete terminalStates[workerId][sessionId];

                // Switch to adjacent tab
                // Simple logic: click the first one available
                const remainingTabs = document.querySelector(`#tabs-list-${workerId}`).children;
                if (remainingTabs.length > 0) {
                    remainingTabs[0].click();
                } else {
                    // No tabs left, maybe create one?
                    // Or show empty state inside the container if we wanted.
                }

                socket.emit('close_session', { worker_id: workerId, session_id: sessionId });
            }


            // Global Event Handlers
            function setActiveWorker(workerId) {
                activeWorkerId = workerId;
                emptyState.style.display = 'none';

                // Sidebar Active State
                document.querySelectorAll('.worker-item').forEach(el => {
                    el.classList.remove('bg-zinc-800', 'border-l-4', 'border-emerald-500', 'text-white');
                    el.classList.add('text-zinc-400', 'hover:bg-zinc-800/50', 'border-l-4', 'border-transparent');
                });
                const activeItem = document.getElementById(`item-${workerId}`);
                if (activeItem) {
                    activeItem.classList.remove('text-zinc-400', 'hover:bg-zinc-800/50', 'border-transparent');
                    activeItem.classList.add('bg-zinc-800', 'border-emerald-500', 'text-white');
                }

                // Default to showing terminal when clicking the main worker item
                showWorkerTerminal(null, workerId);
            }

            function showPage1() {
                // Hide Web UI
                const webUI = document.getElementById('web-ui-container');
                webUI.classList.add('hidden');
                webUI.classList.remove('flex');

                // Hide Empty State
                document.getElementById('empty-state').classList.add('hidden');

                // Hide all terminals
                document.querySelectorAll('.terminal-wrapper').forEach(el => {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                });

                // Show Page 1
                const page = document.getElementById('main-page-1');
                if (page) {
                    page.classList.remove('hidden');
                    page.classList.add('flex');
                }

                // Mobile specific: Close drawer
                if (window.innerWidth < 768) {
                    closeSidePanel();
                }
            }

            function goHome() {
                // Priority: Go to Local Worker's VM Manager
                let targetId = localWorkerId || activeWorkerId;

                if (targetId) {
                    // Update active state if switching from another worker
                    if (targetId !== activeWorkerId) {
                         setActiveWorker(targetId);
                    }
                    
                    showWorkerUI(null, targetId);
                    
                    // Highlight Home Button manually
                    document.querySelectorAll('.sidebar-icon').forEach(icon => {
                        icon.classList.remove('text-white', 'bg-zinc-800', 'active-icon');
                        icon.classList.add('text-zinc-400');
                    });
                    const btn = document.getElementById('btn-home');
                    if(btn) btn.classList.add('text-white', 'bg-zinc-800', 'active-icon');
                    
                } else {
                    // No worker available at all
                     document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.add('hidden'));
                     document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.remove('flex'));
                     const mainPage1 = document.getElementById('main-page-1');
                     if (mainPage1) mainPage1.classList.add('hidden');
                     
                     // Show empty state
                     const empty = document.getElementById('empty-state');
                     if(empty) empty.style.display = 'flex';
                     
                     // Highlight Home
                    document.querySelectorAll('.sidebar-icon').forEach(icon => {
                        icon.classList.remove('text-white', 'bg-zinc-800', 'active-icon');
                        icon.classList.add('text-zinc-400');
                    });
                     const btn = document.getElementById('btn-home');
                    if(btn) btn.classList.add('text-white', 'bg-zinc-800', 'active-icon');
                }
            }

            function showWorkerUI(e, workerId) {
                if (e) e.stopPropagation();

                // Hide all terminals
                // Hide all terminals
                document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.remove('flex'));

                // Hide Main Page 1
                const mainPage1 = document.getElementById('main-page-1');
                if (mainPage1) mainPage1.classList.add('hidden');

                // Show Web UI
                const webUI = document.getElementById('web-ui-container');
                webUI.classList.remove('hidden');
                webUI.classList.add('flex');

                // Update active state in sidebar if needed (visual distinction for sub-menu could be added here)
            }

            function showWorkerTerminal(e, workerId) {
                if (e) e.stopPropagation();

                // Hide Web UI
                const webUI = document.getElementById('web-ui-container');
                webUI.classList.add('hidden');
                webUI.classList.remove('flex');

                // Hide Main Page 1
                const mainPage1 = document.getElementById('main-page-1');
                if (mainPage1) mainPage1.classList.add('hidden');

                // Show Target Terminal
                document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.remove('flex'));

                const activeTerm = document.getElementById(`term-wrapper-${workerId}`);
                if (activeTerm) {
                    activeTerm.classList.remove('hidden');
                    activeTerm.classList.add('flex');

                    const sessionId = activeSessions[workerId];
                    if (sessionId && terminalStates[workerId] && terminalStates[workerId][sessionId]) {
                        setTimeout(() => {
                            terminalStates[workerId][sessionId].fit();
                            terminalStates[workerId][sessionId].term.focus();
                        }, 50);
                    }
                }
            }

            function removeWorker(e, workerId) {
                e.stopPropagation();
                if (confirm('Remove this worker?')) {
                    socket.emit('remove_worker', { worker_id: workerId });
                }
            }

            // Settings handlers (Simplified for this rewrite, just preserving logic stubs)
            function openSettings(e, workerId, name, url, token) {
                e.stopPropagation();
                editIdInput.value = workerId;
                editNameInput.value = name;
                editUrlInput.value = url;
                editTokenInput.value = '';
                settingsModal.classList.remove('hidden');
            }

            function closeSettingsModal() {
                settingsModal.classList.add('hidden');
            }

            function deleteWorkerFromModal() {
                const wid = editIdInput.value;
                if (wid) {
                    socket.emit('remove_worker', { worker_id: wid });
                    closeSettingsModal();
                }
            }

            function saveSettings() {
                const wid = editIdInput.value;
                if (wid) {
                    socket.emit('update_worker', {
                        worker_id: wid,
                        name: editNameInput.value.trim(),
                        url: editUrlInput.value.trim(),
                        token: editTokenInput.value.trim() || null
                    });
                    closeSettingsModal();
                }
            }

            // Socket Events
            socket.on('worker_added', data => {
                const li = document.createElement('li');
                li.id = `item-${data.worker_id}`;
                // Added tooltips for collapsed state
                li.className = 'worker-item group flex flex-col p-2 rounded-lg cursor-pointer border-l-2 border-transparent text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-all duration-200 relative';
                li.title = data.name; // Simple tooltip

                // Check if this is the default local worker
                const isLocal = data.url === 'internal' || data.url.includes('localhost:5002') || data.name.includes('Default Local Terminal') || data.name.includes('Local Host Terminal');
                
                if (isLocal) {
                    localWorkerId = data.worker_id;
                }

                // Base onclick behavior
                li.onclick = () => setActiveWorker(data.worker_id);

                let innerHTML = `
                 <div class="flex items-center gap-3">
                    <div id="status-${data.worker_id}" class="w-2.5 h-2.5 rounded-full ${getStatusColor(data.status)} shadow-sm transition-colors shrink-0"></div>
                    <div class="flex-1 overflow-hidden sidebar-text transition-opacity duration-200">
                        <div class="font-medium text-sm truncate">${data.name}</div>
                        <div class="text-[10px] text-zinc-600 truncate font-mono">${data.url}</div>
                    </div>
                 </div>
                 
                 <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity sidebar-text">
                     <button onclick="openSettings(event, '${data.worker_id}', '${data.name}', '${data.url}', '${data.token}')" class="text-zinc-500 hover:text-white p-1 rounded hover:bg-zinc-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                     </button>
                 </div>
            `;

                // Inject sub-menu for local worker
                if (isLocal) {
                    innerHTML += `
                <div class="mt-2 pl-6 space-y-1 sidebar-text transition-all duration-200 overflow-hidden h-auto" id="submenu-${data.worker_id}">
                    <div onclick="showWorkerTerminal(event, '${data.worker_id}')" class="flex items-center gap-2 p-1.5 rounded hover:bg-zinc-700/50 text-xs text-zinc-400 hover:text-white transition-colors">
                        <span>🖥️</span> <span>Terminal</span>
                    </div>
                    <div onclick="showWorkerUI(event, '${data.worker_id}')" class="flex items-center gap-2 p-1.5 rounded hover:bg-zinc-700/50 text-xs text-zinc-400 hover:text-white transition-colors">
                        <span>🌐</span> <span>Web UI</span>
                    </div>
                </div>
                `;
                }

                li.innerHTML = innerHTML;
                
                // Only append if NOT local
                if (!isLocal) {
                    workerList.appendChild(li);
                }

                // Check collapsed state for new items
                if (isCollapsed) {
                    li.querySelectorAll('.sidebar-text').forEach(el => el.style.opacity = '0');
                }

                createTerminalUI(data.worker_id);

                // Auto-select Default Local Terminal's Web UI if it's the first or local worker
                if (isLocal && !activeWorkerId) {
                    setActiveWorker(data.worker_id);
                    showWorkerUI(null, data.worker_id);
                    // Optimization: Fetch apps immediately
                    setTimeout(() => {
                        fetchModalApps();
                        fetchModalVolumes();
                    }, 500);
                }

                // Reconstruct sessions if any
                if (data.sessions) {
                    for (const [sid, sdata] of Object.entries(data.sessions)) {
                        if (sid !== 'session-1') {
                            addTabUI(data.worker_id, sid);
                        }
                        if (terminalStates[data.worker_id][sid]) {
                            terminalStates[data.worker_id][sid].process(sdata.logs);
                        }
                    }
                }
            });

            socket.on('worker_updated', data => {
                const li = document.getElementById(`item-${data.worker_id}`);
                if (li) {
                    li.querySelector('span.font-medium').textContent = data.name;
                    li.querySelector('span.font-mono').textContent = data.url;
                    // Update onclick handlers for settings button with new data
                    const btn = li.querySelector('button');
                    btn.setAttribute('onclick', `openSettings(event, '${data.worker_id}', '${data.name}', '${data.url}', '${data.token}')`);
                }
            });

            socket.on('worker_removed', data => {
                const li = document.getElementById(`item-${data.worker_id}`);
                if (li) li.remove();
                const term = document.getElementById(`term-${data.worker_id}`);
                if (term) term.remove();
                if (activeWorkerId === data.worker_id) {
                    activeWorkerId = null;
                    emptyState.style.display = 'flex';
                }
            });

            function getStatusColor(status) {
                switch (status) {
                    case 'connected': return 'bg-emerald-500';
                    case 'disconnected': return 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]';
                    case 'connecting': return 'bg-amber-500 animate-pulse';
                    default: return 'bg-zinc-600';
                }
            }

            socket.on('worker_status', data => {
                const indicator = document.getElementById(`status-${data.worker_id}`);
                if (indicator) {
                    indicator.className = `w-2.5 h-2.5 rounded-full ${getStatusColor(data.status)} shadow-sm transition-colors`;
                }
                // Optimization: Fetch apps if active worker connects
                if (data.status === 'connected' && activeWorkerId === data.worker_id) {
                    fetchModalApps();
                }
            });

            socket.on('term_output', data => {
                if (terminalStates[data.worker_id] && terminalStates[data.worker_id][data.session_id]) {
                    terminalStates[data.worker_id][data.session_id].process(data.output);
                }
            });

            socket.on('session_created', data => {
                // Handled efficiently by UI functions, but useful for sync
            });

            socket.on('session_closed', data => {
                // Backend confirmed closure
            });

            // --- Modal App Manager Logic ---

            // This assumes proper execution path. Change as needed.
            // If app.py is in 'images' subdir of 'modal-app-manager':
            const MODAL_WORK_DIR = '{{ work_dir }}';
            const MODAL_BIN = '{{ modal_bin }}';

            // Config Management
            function openConfigModal() {
                const modal = document.getElementById('config-modal');
                const content = document.getElementById('config-modal-content');

                // Load saved values
                document.getElementById('config-app-name').value = localStorage.getItem('modal_app_name') || 'modal_app';
                document.getElementById('config-gpu-type').value = localStorage.getItem('modal_gpu_type') || 'H200';
                document.getElementById('config-timeout').value = localStorage.getItem('modal_timeout') || '86400';
                document.getElementById('config-storage').value = localStorage.getItem('modal_storage') || '';
                document.getElementById('config-region').value = localStorage.getItem('modal_region') || '';
                
                // Fetch and Populate Images
                fetchModalImages();

                // Restore Tab State
                const savedTab = localStorage.getItem('modal_config_active_tab') || 'server';
                switchConfigTab(savedTab);

                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            }
            
            function fetchModalImages() {
                 fetch('/api/fs/list')
                 .then(res => res.json())
                 .then(data => {
                     const select = document.getElementById('config-image');
                     const savedImage = localStorage.getItem('modal_image') || 'app.py';
                     select.innerHTML = '<option value="app.py">app.py (Default)</option>';
                     
                     if (data.files) {
                         data.files.forEach(f => {
                             if(f.type === 'file' && f.name.endsWith('.py') && f.name !== 'app.py') {
                                 const opt = document.createElement('option');
                                 opt.value = f.name;
                                 opt.textContent = f.name;
                                 select.appendChild(opt);
                             }
                         });
                    }
                    select.value = savedImage;
                 });
            }

            function closeConfigModal() {
                const modal = document.getElementById('config-modal');
                const content = document.getElementById('config-modal-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            let activeConfigTab = 'server';

            function switchConfigTab(tab) {
                activeConfigTab = tab;
                
                // Content Visibility
                if(tab === 'server') {
                    document.getElementById('tab-content-server').classList.remove('hidden');
                    document.getElementById('tab-content-restore').classList.add('hidden');
                    
                    // Button Styles
                    document.getElementById('tab-btn-server').classList.add('border-emerald-500', 'text-emerald-400');
                    document.getElementById('tab-btn-server').classList.remove('border-transparent', 'text-zinc-400');
                    document.getElementById('tab-btn-restore').classList.remove('border-emerald-500', 'text-emerald-400');
                    document.getElementById('tab-btn-restore').classList.add('border-transparent', 'text-zinc-400');
                } else {
                    document.getElementById('tab-content-server').classList.add('hidden');
                    document.getElementById('tab-content-restore').classList.remove('hidden');

                    // Button Styles
                    document.getElementById('tab-btn-server').classList.remove('border-emerald-500', 'text-emerald-400');
                    document.getElementById('tab-btn-server').classList.add('border-transparent', 'text-zinc-400');
                    document.getElementById('tab-btn-restore').classList.add('border-emerald-500', 'text-emerald-400');
                    document.getElementById('tab-btn-restore').classList.remove('border-transparent', 'text-zinc-400');
                    
                    // Fetch images if list is empty
                    const s = document.getElementById('config-restore-image');
                    if (s.options.length <= 1) fetchRestoreImages();
                }
            }

            function fetchRestoreImages() {
                 fetch('/api/fs/list?path=restore_model')
                 .then(res => res.json())
                 .then(data => {
                     const select = document.getElementById('config-restore-image');
                     const savedImage = localStorage.getItem('modal_restore_image') || '';
                     select.innerHTML = '<option value="">Select Restore Script...</option>';
                     
                     if (data.files) {
                         data.files.forEach(f => {
                             if(f.type === 'file' && f.name.endsWith('.py')) {
                                 const opt = document.createElement('option');
                                 opt.value = f.name;
                                 opt.textContent = f.name;
                                 select.appendChild(opt);
                             }
                         });
                    }
                    if(savedImage) select.value = savedImage;
                 });
            }

            function applyTemplate(select) {
                const val = select.value;
                const appNameInput = document.getElementById('config-app-name');
                const gpuSelect = document.getElementById('config-gpu-type');
                const timeoutSelect = document.getElementById('config-timeout');
                const storageSelect = document.getElementById('config-storage');
                const regionSelect = document.getElementById('config-region');

                if (!val) return;

                let templateData = {};

                switch (val) {
                    case 'CPU-JKT':
                        templateData = { name: 'cpu-jkt', gpu: 'CPU', timeout: '86400', storage: '', region: 'ap-southeast-3' };
                        break;
                    case 'T4-Light':
                        templateData = { name: 'T4-Light', gpu: 'T4', timeout: '86400', storage: '', region: '' };
                        break;
                    case 'H100-Mid':
                        templateData = { name: 'H100-Mid', gpu: 'H100', timeout: '86400', storage: '', region: '' };
                        break;
                    case 'H200-Heavy':
                        templateData = { name: 'H200-Heavy', gpu: 'H200', timeout: '86400', storage: '', region: '' };
                        break;
                    case 'B200-Beast':
                        templateData = { name: 'B200-Beast', gpu: 'B200', timeout: '86400', storage: '', region: '' };
                        break;
                }

                if (templateData.name) {
                    appNameInput.value = templateData.name;
                    gpuSelect.value = templateData.gpu;
                    timeoutSelect.value = templateData.timeout;
                    storageSelect.value = templateData.storage;
                    regionSelect.value = templateData.region;
                    
                    // Trigger GPU change logic if needed
                    if (window.handleGpuChange) window.handleGpuChange(gpuSelect);
                    if (window.handleRegionChange) window.handleRegionChange(regionSelect);
                }
            }

            function saveConfigModal() {
                localStorage.setItem('modal_config_active_tab', activeConfigTab);

                if (activeConfigTab === 'server') {
                    const appName = document.getElementById('config-app-name').value.trim() || 'modal_app';
                    const gpuType = document.getElementById('config-gpu-type').value;
                    const timeout = document.getElementById('config-timeout').value;
                    const storage = document.getElementById('config-storage').value;
                    const region = document.getElementById('config-region').value;
                    const image = document.getElementById('config-image').value;

                    localStorage.setItem('modal_app_name', appName);
                    localStorage.setItem('modal_gpu_type', gpuType);
                    localStorage.setItem('modal_timeout', timeout);
                    localStorage.setItem('modal_storage', storage);
                    localStorage.setItem('modal_region', region);
                    localStorage.setItem('modal_image', image);
                } else {
                    const restoreImage = document.getElementById('config-restore-image').value;
                    localStorage.setItem('modal_restore_image', restoreImage);
                }

                closeConfigModal();
                updateStartButtonUI(); 
                // Optional: Show a toast or small indicator that config is saved
            }

            function updateStartButtonUI() {
                const activeTab = localStorage.getItem('modal_config_active_tab') || 'server';
                const btn = document.getElementById('start-server-btn');
                
                if (!btn) return;

                // Reset base classes to ensure clean state specific colors
                // Common classes: px-3 md:px-4 py-2 text-white text-xs md:text-sm font-medium rounded-lg transition-colors shadow-lg flex items-center gap-2 flex-1 md:flex-none justify-center whitespace-nowrap
                
                if (activeTab === 'restore') {
                    // Orange Theme
                    btn.className = "px-3 md:px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white text-xs md:text-sm font-medium rounded-lg transition-colors shadow-lg shadow-orange-900/20 flex items-center gap-2 flex-1 md:flex-none justify-center whitespace-nowrap";
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        Restore Model
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 opacity-70"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    `;
                } else {
                    // Emerald Theme (Default)
                    btn.className = "px-3 md:px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs md:text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20 flex items-center gap-2 flex-1 md:flex-none justify-center whitespace-nowrap";
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Start Server
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 opacity-70"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    `;
                }
            }

            let previousRegion = '';
            function handleRegionChange(select) {
                const gpuSelect = document.getElementById('config-gpu-type');
                const newRegion = select.value;

                // If user selects a non-default region AND GPU is not CPU
                if (newRegion !== '' && gpuSelect.value !== 'CPU') {
                    showConfirmModal(
                        "Selecting a specific Region requires 'CPU Only'.\n\nSwitch GPU to CPU?",
                        () => {
                            // On Confirm: Set GPU to CPU and set the Region to the new value
                            gpuSelect.value = 'CPU';
                            select.value = newRegion;
                            previousRegion = newRegion;
                        }
                    );

                    // Temporarily revert to previous valid selection.
                    select.value = previousRegion;
                } else {
                    previousRegion = newRegion;
                }
            }

            let previousGpu = 'H200'; // Default
            function handleGpuChange(select) {
                const regionSelect = document.getElementById('config-region');
                const newGpu = select.value;

                // If user selects a GPU (not CPU) AND Region is not Default
                if (newGpu !== 'CPU' && regionSelect.value !== '') {
                    showConfirmModal(
                        "Using a GPU requires Default Region.\n\nSwitch Region to Default?",
                        () => {
                            // On Confirm: Set Region to Default
                            regionSelect.value = '';
                            select.value = newGpu;
                            previousGpu = newGpu;
                            previousRegion = ''; // Sync region logic
                        }
                    );

                    // Temporarily revert
                    select.value = previousGpu;
                } else {
                    previousGpu = newGpu;
                }
            }

            // --- Create Volume Modal Logic ---
            function openCreateVolumeModal() {
                const modal = document.getElementById('create-volume-modal');
                const content = document.getElementById('create-volume-modal-content');
                document.getElementById('create-volume-name').value = ''; // Reset
                
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            }

            function closeCreateVolumeModal() {
                const modal = document.getElementById('create-volume-modal');
                const content = document.getElementById('create-volume-modal-content');
                
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            async function createModalVolume() {
                const nameInput = document.getElementById('create-volume-name');
                const btn = document.getElementById('btn-create-volume-confirm');
                const name = nameInput.value.trim();
                
                if (!name) return alert("Volume name is required");
                if (!/^[a-zA-Z0-9_\-]+$/.test(name)) return alert("Invalid characters. Use letters, numbers, dashes, and underscores only.");
                
                const originalBtnText = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin inline-block">⌛</span> Creating...';
                btn.disabled = true;

                try {
                    const res = await fetch('/api/modal/volume/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: name })
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok) {
                        closeCreateVolumeModal();
                        fetchModalVolumes(); // Refresh list
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                } catch (e) {
                    alert("Network error: " + e);
                } finally {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                }
            }


            // Dropdown Logic
            function toggleStartMenu() {
                const menu = document.getElementById('start-menu-dropdown');
                menu.classList.toggle('hidden');
            }
            
            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('start-menu-dropdown');
                const btn = document.getElementById('start-server-btn');
                if (menu && !menu.classList.contains('hidden')) {
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                }
            });

            function handleStartOption(mode) {
                document.getElementById('start-menu-dropdown').classList.add('hidden');
                startModalServer(mode);
            }

            function startModalServer(mode = 'standard') {
                if (!activeWorkerId) return alert("Select a worker first");

                // Get Config
                const activeTab = localStorage.getItem('modal_config_active_tab') || 'server';
                let fullCommand = '';
                
                if (activeTab === 'restore') {
                     const restoreImage = localStorage.getItem('modal_restore_image');
                     if (!restoreImage) return alert("Please select a restore image first in configuration.");
                     const imagePath = `restore_model/${restoreImage}`;
                     fullCommand = `${MODAL_BIN} run --detach ${imagePath}`;
                } else {
                    const appName = localStorage.getItem('modal_app_name') || 'modal_app';
                    const gpuType = localStorage.getItem('modal_gpu_type') || 'H200';
                    const timeout = localStorage.getItem('modal_timeout') || '86400';
                    const storage = localStorage.getItem('modal_storage') || '';
                    const region = localStorage.getItem('modal_region') || '';
                    const image = localStorage.getItem('modal_image') || 'app.py';

                    // Construct full command with env vars
                    let envVars = `MODAL_APP_NAME="${appName}" MODAL_TIMEOUT="${timeout}"`;
                    if (gpuType !== 'CPU') {
                        envVars += ` MODAL_GPU="${gpuType}"`;
                    }
                    if (storage) envVars += ` MODAL_DISK="${storage}"`;
                    if (region) envVars += ` MODAL_REGION="${region}"`;

                    fullCommand = `${envVars} ${MODAL_BIN} run --detach ${image}`;
                }

                // Logic to execute start (shows final command confirmation)
                const proceedWithStart = () => {
                    const startModeStr = mode === 'terminal' ? "Terminal Mode" : "Standard Mode";
                    const configModeStr = activeTab === 'restore' ? "(Restore Mode)" : "(Server Mode)";
                    const msg = `Start Server ${configModeStr} - ${startModeStr}?\n\n<div class="bg-black/50 p-2 rounded text-xs overflow-x-auto mt-2 text-emerald-400 font-mono break-all">${fullCommand}</div>`;

                    showConfirmModal(msg, () => {
                        const btn = document.getElementById('start-server-btn');
                        if(btn) {
                            btn.disabled = true;
                            btn.classList.add('opacity-75', 'cursor-not-allowed');
                        }

                        if (mode === 'terminal') {
                             // 1. Show Terminal Wrapper
                             showWorkerTerminal(null, activeWorkerId);
                             
                             // 2. Create Fresh Session
                             const newSessionId = 'server-' + Math.random().toString(36).substr(2, 6);
                             createNewSession(activeWorkerId, newSessionId);
                             
                             // 3. Switch to New Session (Focus)
                             setTimeout(() => {
                                 switchTab(activeWorkerId, newSessionId);
                             }, 100);

                             // 4. Send Command
                             setTimeout(() => {
                                const termCmd = `cd ${MODAL_WORK_DIR} && ${fullCommand}`;
                                 socket.emit('term_input', {
                                    worker_id: activeWorkerId,
                                    session_id: newSessionId,
                                    input: termCmd + '\r'
                                });
                             }, 1000); // Increased waiting time to ensure session ready
                             
                             setTimeout(() => {
                                if(btn) {
                                    btn.disabled = false;
                                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                                }
                            }, 1000);
                             return;
                        }

                        // Standard Mode
                        console.log(`[Frontend] Emitting exec_command: ${fullCommand}`);
                        socket.emit('exec_command', {
                            worker_id: activeWorkerId,
                            command: fullCommand,
                            cwd: MODAL_WORK_DIR,
                            id: 'start-server'
                        });

                        setTimeout(() => {
                            if(btn) {
                                btn.disabled = false;
                                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                            }
                        }, 5000);
                    });
                };

                // Check for existing running apps
                if (cachedAppsOutput) {
                    try {
                         const jsonStart = cachedAppsOutput.indexOf('[');
                         const jsonEnd = cachedAppsOutput.lastIndexOf(']');
                         if (jsonStart !== -1 && jsonEnd !== -1) {
                             const jsonStr = cachedAppsOutput.substring(jsonStart, jsonEnd + 1);
                             const apps = JSON.parse(jsonStr);
                             
                             const activeApp = apps.find(app => {
                                 const s = (app['State'] || '').toLowerCase();
                                 return s.includes('running') || s.includes('ephemeral') || s.includes('detach');
                             });

                             if (activeApp) {
                                 const confirmMsg = `Server <span class="text-emerald-400 font-mono">${activeApp['Description'] || activeApp['App ID']}</span> is already active.<br><br>Do you want to start another instance?`;
                                 showConfirmModal(confirmMsg, () => {
                                     // Add delay to allow previous modal to close properly
                                     setTimeout(() => {
                                         proceedWithStart();
                                     }, 400); 
                                 });
                                 return;
                             }
                         }
                    } catch (e) {
                        console.warn("Failed to parse cached apps for check:", e);
                    }
                }

                // Default path
                proceedWithStart();
            }


            // Global Caches for UI Sync
            let cachedAppsOutput = null;
            let cachedWalletData = null;
            let appReadyState = {}; // { appId: boolean }
            let pendingReadyChecks = new Set();

            function fetchModalApps() {
                if (!activeWorkerId) return;

                // Show loading state in table?
                const tbody = document.getElementById('modal-app-list');
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-zinc-500 animate-pulse">Loading...</td></tr>`;

                console.log(`[Frontend] Emitting exec_command: ${MODAL_BIN} app list`);
                socket.emit('exec_command', {
                    worker_id: activeWorkerId,
                    command: `${MODAL_BIN} app list --json`,
                    cwd: MODAL_WORK_DIR, // Context might matter for config
                    id: 'list-apps'
                });
            }

            function fetchModalVolumes() {
                const list = document.getElementById('modal-volume-list');
                // Don't wipe if we want to be subtle, but for now loading state is good
                list.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-zinc-500 animate-pulse">Loading volumes...</td></tr>';
                
                fetch('/api/modal/volumes')
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = '';
                    if(data.error) {
                         list.innerHTML = `<tr><td colspan="3" class="p-3 text-center text-red-500">Error: ${data.error}</td></tr>`;
                         return;
                    }
                    if(!data.volumes || data.volumes.length === 0) {
                        list.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-zinc-500">No volumes found</td></tr>';
                        return;
                    }
                    
                    data.volumes.forEach(vol => {
                         const tr = document.createElement('tr');
                         tr.className = 'hover:bg-zinc-800/30 transition-colors group';
                         
                         const created = vol['Created at'] || 'Unknown';
                         const owner = vol['Created by'] || 'Unknown';
                         
                         tr.innerHTML = `
                            <td class="p-3 border-b border-zinc-800/50 font-medium text-emerald-400 cursor-pointer hover:underline" onclick="openVolumeInspector('${vol.Name}')">
                                <span class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                    ${vol.Name}
                                </span>
                            </td>
                            <td class="p-3 border-b border-zinc-800/50 text-zinc-400 text-xs">${created}</td>
                            <td class="p-3 border-b border-zinc-800/50 text-zinc-500 text-xs">${owner}</td>
                            <td class="p-3 border-b border-zinc-800/50 text-right">
                                <button onclick="openDeleteVolumeModal('${vol.Name}')" class="px-3 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 text-xs rounded transition-colors border border-red-500/20 font-medium">Delete</button>
                            </td>
                         `;
                         list.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    list.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-red-500">Failed to load</td></tr>';
                });
            }



            // --- Delete Volume Modal Logic ---
            let volumeToDelete = null;

            function openDeleteVolumeModal(name) {
                volumeToDelete = name;
                const modal = document.getElementById('delete-volume-modal');
                const content = document.getElementById('delete-volume-modal-content');
                document.getElementById('delete-volume-target').textContent = name;
                
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            }

            function closeDeleteVolumeModal() {
                const modal = document.getElementById('delete-volume-modal');
                const content = document.getElementById('delete-volume-modal-content');
                volumeToDelete = null;
                
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            async function confirmDeleteModalVolume() {
                if (!volumeToDelete) return;
                
                const btn = document.getElementById('btn-delete-volume-confirm');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin inline-block">⌛</span> Deleting...';
                btn.disabled = true;

                try {
                    const res = await fetch('/api/modal/volume/delete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: volumeToDelete })
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok) {
                        closeDeleteVolumeModal();
                        fetchModalVolumes();
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                } catch (e) {
                    alert("Network error: " + e);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // --- Volume Inspector Logic ---
            let currentInspectorVolume = null;
            let currentInspectorPath = '/';

            function openVolumeInspector(volName) {
                currentInspectorVolume = volName;
                currentInspectorPath = '/';
                
                const modal = document.getElementById('volume-inspector-modal');
                const content = document.getElementById('volume-inspector-modal-content');
                document.getElementById('volume-inspector-title').textContent = volName;
                
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
                
                fetchVolumeFiles();
            }

            function closeVolumeInspector() {
                const modal = document.getElementById('volume-inspector-modal');
                const content = document.getElementById('volume-inspector-modal-content');
                currentInspectorVolume = null;
                
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            function fetchVolumeFiles(path) {
                if(path !== undefined) currentInspectorPath = path;
                
                const list = document.getElementById('volume-inspector-list');
                const pathDisplay = document.getElementById('volume-inspector-path');
                const backBtn = document.getElementById('volume-inspector-back');
                
                pathDisplay.textContent = currentInspectorPath;
                if(currentInspectorPath === '/' || currentInspectorPath === '') {
                    backBtn.classList.add('hidden');
                } else {
                    backBtn.classList.remove('hidden');
                }

                list.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-zinc-500 animate-pulse">Loading files...</td></tr>';

                fetch('/api/modal/volume/files', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ name: currentInspectorVolume, path: currentInspectorPath })
                })
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = '';
                    if(data.error) {
                        list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error: ${data.error}</td></tr>`;
                        return;
                    }
                    if(!data.files || data.files.length === 0) {
                        list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-zinc-500">Empty directory</td></tr>`;
                        return;
                    }
                    
                    renderVolumeFileList(data.files);
                })
                .catch(err => {
                    console.error(err);
                    list.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Failed to load</td></tr>';
                });
            }

            function renderVolumeFileList(files) {
                const list = document.getElementById('volume-inspector-list');
                
                // Sort: Folders first, then files
                files.sort((a, b) => {
                    if (a.Type === b.Type) return a.Filename.localeCompare(b.Filename);
                    return a.Type === 'dir' ? -1 : 1;
                });

                const currentPathParts = currentInspectorPath === '/' ? [] : currentInspectorPath.split('/');
                const currentPathDepth = currentPathParts.length;

                files.forEach(file => {
                     const tr = document.createElement('tr');
                     tr.className = 'hover:bg-zinc-800/50 transition-colors group cursor-pointer';
                     
                     // Modal returns the full relative path in Filename (e.g., "models/checkpoints")
                     // We want to display just the basename (e.g., "checkpoints")
                     const relativePath = file.Filename; 
                     const displayName = relativePath.split('/').pop();

                     // However, if the API returns a relative path from the *current* query, 
                     // we need to be careful. 
                     // Based on tests: list 'models' -> returns 'models/checkpoints'.
                     // So Filename IS the full path to the object from volume root.
                     
                     let icon = '';
                     let nameHtml = displayName;
                     let clickHandler = '';

                     if (file.Type === 'dir') {
                         icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 fill-blue-500/20"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;
                         // Verify this logic: if we are at root, Filename is "models". 
                         // if we click "models", we query "models".
                         // it returns "models/checkpoints".
                         // We click that, we query "models/checkpoints".
                         clickHandler = `onclick="fetchVolumeFiles('${relativePath}')"`;
                         nameHtml = `<span class="text-blue-400 group-hover:underline font-medium">${displayName}</span>`;
                     } else {
                         icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
                         nameHtml = `<span class="text-zinc-300">${displayName}</span>`;
                     }

                     tr.innerHTML = `
                        <td class="p-2 w-8 text-center" ${clickHandler}>${icon}</td>
                        <td class="p-2" ${clickHandler}>${nameHtml}</td>
                        <td class="p-2 text-zinc-500 text-xs">${file.Size}</td>
                        <td class="p-2 text-zinc-500 text-xs text-right whitespace-nowrap">${file['Created/Modified']}</td>
                        <td class="p-2 text-right">
                            <button onclick="event.stopPropagation(); openDeleteFileModal('${displayName}', '${relativePath}')"
                                class="p-1 text-zinc-500 hover:text-red-400 hover:bg-zinc-700/50 rounded transition-colors" title="Delete">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </td>
                     `;
                     list.appendChild(tr);
                });
            }

            function volumeInspectorUp() {
                if(currentInspectorPath === '/' || currentInspectorPath === '') return;
                const parts = currentInspectorPath.split('/');
                parts.pop();
                const parent = parts.join('/') || '/';
                fetchVolumeFiles(parent);
            }

             let currentDeleteFile = null;
             let currentDeleteFilePath = null;

             function openDeleteFileModal(name, path) {
                 currentDeleteFile = name;
                 currentDeleteFilePath = path;
                 document.getElementById('delete-file-target').innerText = name;
                 
                 const modal = document.getElementById('delete-file-modal');
                 modal.classList.remove('hidden');
                 requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    document.getElementById('delete-file-modal-content').classList.remove('scale-95');
                    document.getElementById('delete-file-modal-content').classList.add('scale-100');
                 });
             }

             function closeDeleteFileModal() {
                 const modal = document.getElementById('delete-file-modal');
                 
                 modal.classList.add('opacity-0');
                 document.getElementById('delete-file-modal-content').classList.remove('scale-100');
                 document.getElementById('delete-file-modal-content').classList.add('scale-95');
                 setTimeout(() => {
                     modal.classList.add('hidden');
                     currentDeleteFile = null;
                     currentDeleteFilePath = null;
                 }, 200);
             }

             function confirmDeleteFile() {
                 if (!currentDeleteFile || !currentDeleteFilePath || !currentInspectorVolume) return;
                 
                 const btn = document.getElementById('btn-delete-file-confirm');
                 const originalText = btn.innerHTML;
                 btn.textContent = 'Deleting...';
                 btn.disabled = true;

                 fetch('/api/modal/volume/rm', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ 
                         volume_name: currentInspectorVolume, 
                         path: currentDeleteFilePath 
                     })
                 })
                 .then(res => res.json())
                 .then(data => {
                     if (data.status === 'success') {
                         closeDeleteFileModal();
                         fetchVolumeFiles(); // Refresh list
                     } else {
                         alert('Error deleting file: ' + (data.error || 'Unknown error'));
                     }
                 })
                 .catch(err => {
                     console.error(err);
                     alert('Network error');
                 })
                 .finally(() => {
                     btn.innerHTML = originalText;
                     btn.disabled = false;
                 });
             }

            function checkAppReadiness(appId) {
                if (!activeWorkerId || pendingReadyChecks.has(appId)) return;
                
                // Mark as pending to avoid duplicate checks
                pendingReadyChecks.add(appId);
                
                // Use timeout and grep to be efficient. grep -m 1 ensures we stop after first match.
                // Redirect stderr to /dev/null to avoid noise.
                const cmd = `${MODAL_BIN} app logs ${appId} | grep -m 1 "SERVER MODAL TELAH AKTIF!"`;
                
                // We use a small hack: timeout is handled by the browser socket timeout, 
                // but let's assume grep returns quickly if it finds it.
                // BUT modal app logs might stream. We MUST use timeout.
                const safeCmd = `timeout 5s ${cmd}`;

                socket.emit('exec_command', {
                    worker_id: activeWorkerId,
                    command: safeCmd,
                    cwd: MODAL_WORK_DIR,
                    id: `check-app-ready:${appId}`
                });
            }

            function showAppLogs(appId) {
                if (!activeWorkerId) return;

                // switch to terminal view
                showWorkerTerminal(null, activeWorkerId);
                
                // Construct command
                const command = `${MODAL_BIN} app logs ${appId}`;
                
                // Send to active terminal session
                const sessionId = activeSessions[activeWorkerId];
                console.log(`[Frontend] showAppLogs: Sending logs command to Worker: ${activeWorkerId}, Session: ${sessionId}`);
                
                if (sessionId) {
                    console.log(`[Frontend] showAppLogs: Sending Ctrl+C...`);
                    // Send Send Ctrl+C first to ensure clean line, then command
                    socket.emit('term_input', {worker_id: activeWorkerId, session_id: sessionId, input: '\x03'}); 
                    setTimeout(() => {
                        console.log(`[Frontend] showAppLogs: Sending Command: ${command}`);
                        socket.emit('term_input', {
                            worker_id: activeWorkerId, 
                            session_id: sessionId, 
                            input: command + '\n'
                        });
                    }, 500); // Delay for safety
                } else {
                    console.error('[Frontend] showAppLogs: No active session found!');
                    alert('No active terminal session to run logs.');
                }
            }

            function closeLogsModal() {
                const modal = document.getElementById('logs-modal');
                const content = document.getElementById('logs-modal-content');

                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');

                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }

            socket.on('exec_result', data => {
                // console.log("Exec result:", data);

                if (data.id === 'start-server') {
                    if (data.returncode === 0) {
                        console.log("Server started:", data.stdout);
                        fetchModalApps();
                    } else {
                        // Suppress RemoteError/Traceback for start-server too per user request
                        const err = data.stderr || data.error || "";
                        if (err.includes("RemoteError") || (err.includes("Traceback") && err.includes("modal"))) {
                            console.warn("Suppressing RemoteError for start-server:", err);
                            // Assuming it might have worked or user doesn't care
                            fetchModalApps();
                        } else {
                            alert("Failed to start server:\n" + err);
                        }
                    }
                } else if (data.id && data.id.startsWith('check-app-ready:')) {
                    // ID format: check-app-ready:APP_ID
                    const appId = data.id.split(':')[1];
                    pendingReadyChecks.delete(appId);
                    
                    // If return code 0, grep found the line -> Ready
                    if (data.returncode === 0 && data.stdout && data.stdout.trim().length > 0) {
                        appReadyState[appId] = true;
                        // Trigger simple re-render
                        renderAppsTable(null);
                    } else {
                        // Not found or error -> Not Ready yet (keep false/undefined)
                        // appReadyState[appId] = false; 
                    }
                } else if (data.id === 'list-apps') {
                    if (data.returncode !== 0) {
                        renderAppsTable(null, data.stderr || "Worker disconnected or error");
                    } else {
                        renderAppsTable(data.stdout);
                    }
                } else if (data.id === 'fetch-app-logs') {
                    const logsPre = document.getElementById('logs-pre');
                    if (logsPre) {
                        // Return code 124 is timeout (expected for streaming command)
                        // Return code 0 is clean exit
                        if (data.returncode === 0 || data.returncode === 124) {
                            logsPre.textContent = data.stdout || "(No output captured)";
                        } else {
                            logsPre.textContent = `Error fetching logs (Code ${data.returncode}):\n${data.stderr || data.error}`;
                        }
                    }
                } else if (data.id === 'stop-app') {
                    if (data.returncode !== 0) {
                        // Suppress known "RemoteError" valid stop signal
                        const err = data.stderr || data.error || "";
                        if (err.includes("RemoteError") && !err.includes("Traceback")) {
                            // Sometimes it's just a clean RemoteError, but user saw Traceback. 
                            // Check for "RemoteError" generally as per user request to suppress.
                            console.warn("Suppressing RemoteError for stop-app:", err);
                            fetchModalApps();
                        } else if (err.includes("Traceback") && err.includes("modal")) {
                            // The traceback shown by user is effectively a success signal for 'detached' apps in some versions
                            console.warn("Suppressing Traceback for stop-app (assumed success):", err);
                            fetchModalApps();
                        } else {
                            alert("Failed to stop app:\n" + err);
                        }
                    } else {
                        fetchModalApps();
                    }
                } else if (data.id === 'get-profile-current') {
                    const profile = data.stdout ? data.stdout.trim() : 'Unknown';
                    const el = document.getElementById('current-profile-name');
                    if (el) {
                        el.textContent = profile;
                        startBalancePolling(); // Always poll for any profile
                    }
                } else if (data.id === 'list-profiles') {
                    renderProfilesDisplay(data.stdout);
                } else if (data.id === 'activate-profile') {
                    if (data.returncode === 0) {
                        fetchModalProfile(); // Refresh current profile display
                        fetchModalApps(); // Refresh apps list for new profile
                    } else {
                        alert("Failed to switch profile:\n" + (data.stderr || data.error));
                        fetchModalProfile(); // Revert display on error
                    }
                } else if (data.id === 'fetch-balance') {
                    console.log("[Debug] Fetch Balance Response:", data);

                    if (data.returncode === 0 && data.stdout) {
                        try {
                            const wallet = JSON.parse(data.stdout);
                            const currentProfile = document.getElementById('current-profile-name').textContent.trim();

                            console.log(`[Debug] Wallet Account: ${wallet.account}, Current Profile: ${currentProfile}`);
                            
                            // Cache wallet data globally
                            cachedWalletData = wallet;

                            // Update Wallet Logs Button Style
                            const logsBtn = document.getElementById('wallet-logs-btn');
                            if (logsBtn) {
                                const now = Date.now() / 1000;
                                const isSpending = wallet.last_signal_time && (now - wallet.last_signal_time) < 60;
                                
                                if (isSpending) {
                                    logsBtn.className = "px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors border border-zinc-700 flex items-center justify-center gap-2 text-emerald-500 shadow-lg shadow-emerald-900/20";
                                } else {
                                    logsBtn.className = "px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded-lg transition-colors border border-zinc-700 flex items-center justify-center gap-2";
                                }
                            }
                            
                            // Trigger re-render of apps table to update indicators (using cached apps output)
                            renderAppsTable(null);

                            // Always update if account matches, or maybe just update anyway for debug
                            if (wallet.account === currentProfile) {
                                const balanceEl = document.getElementById('balance-value');
                                const container = document.getElementById('profile-balance');

                                balanceEl.textContent = `$${parseFloat(wallet.balance).toFixed(4)}`;
                                container.classList.remove('hidden');
                                container.classList.add('flex');
                            } else {
                                console.warn("[Debug] Profile mismatch!", wallet.account, currentProfile);
                            }
                        } catch (e) {
                            console.error("Failed to parse wallet json:", e);
                            console.log("Raw stdout:", data.stdout);
                        }
                    } else {
                        console.error("Fetch balance failed or empty stdout:", data);
                        const container = document.getElementById('profile-balance');
                        const balanceEl = document.getElementById('balance-value');
                        // Optional: Show error state in UI
                        if (container) {
                            container.classList.remove('hidden');
                            container.classList.add('flex');
                            balanceEl.textContent = "Error";
                        }
                    }
                } else if (data.id === 'fetch-wallet-logs') {
                    if (data.returncode === 0 && data.stdout) {
                        try {
                            const wallet = JSON.parse(data.stdout);
                            renderWalletLogs(wallet);
                        } catch (e) {
                            console.error("Failed to parse wallet logs:", e);
                            renderWalletLogs(null); // Show empty/error state
                        }
                    } else {
                        console.error("Fetch logs failed:", data);
                        renderWalletLogs(null);
                    }
                }
            });

            // Custom Modal Logic
            function showConfirmModal(message, onConfirm) {
                const modal = document.getElementById('confirm-modal');
                const content = document.getElementById('confirm-modal-content');
                const msgEl = document.getElementById('confirm-modal-message');
                const btn = document.getElementById('confirm-modal-btn');
                const cancelBtn = btn.previousElementSibling;

                msgEl.innerHTML = message;
                confirmResultHandler = onConfirm;

                // Restore Standard Confirm Style
                cancelBtn.classList.remove('hidden');
                btn.innerText = "Confirm";
                btn.className = "px-4 py-2 text-sm bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 hover:bg-emerald-500 hover:text-white rounded-lg transition-all font-medium";

                modal.classList.remove('hidden');
                // Animate in
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });

                // Clean previous listeners via cloning (simple trick) or explicit remove
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', () => {
                    if (confirmResultHandler) confirmResultHandler();
                    closeConfirmModal();
                });
            }

            function showAlertModal(message) {
                const modal = document.getElementById('confirm-modal');
                const content = document.getElementById('confirm-modal-content');
                const msgEl = document.getElementById('confirm-modal-message');
                const btn = document.getElementById('confirm-modal-btn');
                const cancelBtn = btn.previousElementSibling;

                msgEl.innerHTML = message;

                // Alert Style
                cancelBtn.classList.add('hidden');
                btn.innerText = "OK";
                btn.className = "px-4 py-2 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all font-medium";

                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });

                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', () => {
                    closeConfirmModal();
                });
            }            

            function closeConfirmModal() {
                const modal = document.getElementById('confirm-modal');
                const content = document.getElementById('confirm-modal-content');

                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    confirmResultHandler = null;
                }, 200);
            }

            function stopModalApp(appId) {
                if (!activeWorkerId) return;

                showConfirmModal(`Stop app "${appId}"? This cannot be undone.`, () => {
                    console.log(`[Frontend] Stopping app: ${appId}`);
                    socket.emit('exec_command', {
                        worker_id: activeWorkerId,
                        command: `${MODAL_BIN} app stop ${appId}`,
                        cwd: MODAL_WORK_DIR,
                        id: 'stop-app'
                    });

                    // Optimistically refresh
                    setTimeout(() => fetchModalApps(), 2000);
                });
            }

            function renderAppsTable(output = null, errorMsg = null) {
                const tbody = document.getElementById('modal-app-list');
                
                // Update Cache if new output provided
                if (output) {
                    cachedAppsOutput = output;
                }

                // Use cached output if no new output (for re-renders via wallet update)
                const dataToRender = output || cachedAppsOutput;

                if (errorMsg) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 font-medium bg-red-500/5 rounded-lg border border-red-500/10 mb-2">${errorMsg}</td></tr>`;
                    return;
                }

                if (!dataToRender || dataToRender.trim() === '') {
                    // Only clear if we actually ran fetch-apps and it returned empty, or cache is empty
                     if (!cachedAppsOutput) {
                        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-zinc-500">No output returned.</td></tr>`;
                     }
                     // If we have cache but output argument was null, we proceed to render cache. 
                     // But here dataToRender is null means both are null.
                     return;
                }
                
                // Re-clear logic handled by render
                tbody.innerHTML = '';
                
                const outputStr = dataToRender; // alias

                let parsedApps = null;

                // Robust JSON extraction (finds [ ... ])
                const jsonStart = outputStr.indexOf('[');
                const jsonEnd = outputStr.lastIndexOf(']');
                if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                    try {
                        const jsonStr = outputStr.substring(jsonStart, jsonEnd + 1);
                        parsedApps = JSON.parse(jsonStr);
                    } catch (e) {
                        console.warn("Extracted JSON extraction failed", e);
                    }
                }

                if (!parsedApps) {
                    try {
                        parsedApps = JSON.parse(outputStr);
                    } catch (e) {
                        // console.log("Parsing legacy text output (fallback).");
                    }
                }

                // Helper for Connectivity Signal
                const isClientConnected = () => {
                   if (!cachedWalletData) return false;
                   const now = Date.now() / 1000;
                   
                   // Check new Sessions dict
                   if (cachedWalletData.sessions) {
                       const timestamps = Object.values(cachedWalletData.sessions);
                       for (const ts of timestamps) {
                           if ((now - ts) < 60) return true;
                       }
                   }
                   
                   // Fallback to legacy field
                   if (cachedWalletData.last_signal_time) {
                       return (now - cachedWalletData.last_signal_time) < 60;
                   }
                   
                   return false;
                };
                
                const connected = isClientConnected();

                if (Array.isArray(parsedApps)) {
                    if (parsedApps.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-zinc-500">No apps found.</td></tr>`;
                        return;
                    }

                    for (const app of parsedApps) {
                        const appId = app['App ID'];
                        const desc = app['Description'];
                        const state = app['State'];
                        const created = app['Created at'] || '-';
                        const stopped = app['Stopped at'] || '-';

                        const formatDate = (dateStr) => {
                            if (!dateStr || dateStr === '-') return '-';
                            try {
                                return dateStr.replace(/^\d{4}-/, '').split('+')[0].trim();
                            } catch (e) { return dateStr; }
                        };

                        const createdFmt = formatDate(created);
                        const stoppedFmt = formatDate(stopped);

                        const isRunning = state.toLowerCase().includes('ephemeral') || state.toLowerCase().includes('detach') || state.toLowerCase().includes('running');

                        let actionHtml = '';
                        if (isRunning) {
                            const isReady = appReadyState[appId];
                            // VS Code Button Logic (Renamed to Code)
                            const vscodeBtn = isReady ? 
                                `<a href="https://code-server.jekarta.site" target="_blank" class="w-full md:w-auto justify-center px-2 py-1 bg-sky-500/10 hover:bg-sky-500/20 text-sky-500 rounded text-xs border border-sky-500/20 transition-colors flex items-center gap-1 shadow-lg shadow-sky-900/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                    Code
                                 </a>` :
                                `<button disabled class="w-full md:w-auto justify-center px-2 py-1 bg-zinc-500/5 text-zinc-600 rounded text-xs border border-zinc-500/10 cursor-not-allowed flex items-center gap-1 grayscale opacity-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                    Code
                                 </button>`;

                            actionHtml = `
                            <div class="flex flex-col md:flex-row gap-2 justify-end items-stretch md:items-center">
                                ${vscodeBtn}
                                <div class="hidden md:block w-px h-4 bg-zinc-800 mx-1"></div>
                                <div class="flex gap-2">
                                    <button onclick="showAppLogs('${appId}')" class="flex-1 md:flex-none justify-center px-2 py-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-500 rounded text-xs border border-blue-500/20 transition-colors flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                        Logs
                                    </button>
                                    <button onclick="stopModalApp('${appId}')" class="flex-1 md:flex-none justify-center px-2 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded text-xs border border-red-500/20 transition-colors flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                                        Stop
                                    </button>
                                </div>
                            </div>
                            `;
                        }

                        // Added active-server-glow class if running
                        const tr = document.createElement('tr');
                        tr.className = `hover:bg-zinc-800/50 transition-colors ${isRunning ? 'active-server-glow' : ''}`;
                        
                        // Modified State Column to include signal
                        const signalIndicator = isRunning ? (connected ? 
                            `<span class="flex h-2 w-2 relative" title="Client Connected">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                            </span>` : 
                            `<span class="flex h-2 w-2 rounded-full bg-red-500/50" title="Client Not Connected"></span>`
                        ) : '';

                        // Readiness Logic
                        let stateClass = getStateClass(state);
                        if (isRunning) {
                             if (!appReadyState[appId]) {
                                 // Not Ready -> Yellow Pulse
                                 stateClass = 'bg-yellow-500/10 text-yellow-500 border border-yellow-500/20 animate-pulse';
                                 // Trigger check if not pending
                                 checkAppReadiness(appId);
                             } else {
                                 // Ready -> Green (Default Emerald usually works, but let's force it clean)
                                 stateClass = 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20';
                             }
                        }

                        tr.innerHTML = `
                        <td class="p-3 border-b border-zinc-800/50">
                            <div class="flex items-center gap-2 mb-1">
                                ${signalIndicator}
                                <div class="font-medium text-emerald-400 text-sm">${desc}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${stateClass}">
                                    ${state}
                                </span>
                            </div>
                        </td>
                        <td class="p-3 border-b border-zinc-800/50 text-zinc-500 text-[10px] font-mono">
                            <div><span class="text-zinc-600">C:</span> ${createdFmt}</div>
                            ${stoppedFmt !== '-' ? `<div><span class="text-zinc-600">S:</span> ${stoppedFmt}</div>` : ''}
                        </td>
                        <td class="p-3 border-b border-zinc-800/50 text-right">
                            ${actionHtml}
                        </td>
                    `;
                        tbody.appendChild(tr);
                    }
                    return;
                }

                // Legacy text parsing
                const lines = output.trim().split('\n');
                let foundApps = 0;

                for (let line of lines) {
                    line = line.trim();
                    // Parse rows that start with │ (U+2502)
                    if (line.startsWith('│')) {
                        // Structure: │ App ID │ Description │ State │ Tasks │ Created at │ Stopped at │
                        // Split by │ and filter out empty strings resulting from start/end
                        const cols = line.split('│').map(c => c.trim()).filter(c => c !== '');

                        if (cols.length >= 5) {
                            const appId = cols[0];
                            const desc = cols[1];
                            const state = cols[2];
                            // const tasks = cols[3];
                            const created = cols[4] || '-';
                            const stopped = cols[5] || '-';

                            const formatDate = (dateStr) => {
                                if (!dateStr || dateStr === '-') return '-';
                                try {
                                    return dateStr.replace(/^\d{4}-/, '').split('+')[0].trim();
                                } catch (e) { return dateStr; }
                            };

                            const createdFmt = formatDate(created);
                            const stoppedFmt = formatDate(stopped);

                            const isRunning = state.toLowerCase().includes('ephemeral') || state.toLowerCase().includes('detach');

                            let actionHtml = '';
                            if (isRunning) {
                                actionHtml = `
                                <div class="flex gap-2 justify-end">
                                    <button onclick="stopModalApp('${appId}')" class="px-2 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded text-xs border border-red-500/20 transition-colors flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                                        Stop
                                    </button>
                                </div>
                                `;
                            }

                            const tr = document.createElement('tr');
                            tr.className = 'hover:bg-zinc-800/50 transition-colors';
                            tr.innerHTML = `
                            <td class="p-3 border-b border-zinc-800/50">
                                <div class="font-medium text-emerald-400 text-sm mb-1">${desc}</div>
                                <div class="flex items-center gap-2">
                                     <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${getStateClass(state)}">
                                        ${state}
                                    </span>
                                </div>
                            </td>
                            <td class="p-3 border-b border-zinc-800/50 text-zinc-500 text-[10px] font-mono">
                                <div><span class="text-zinc-600">C:</span> ${createdFmt}</div>
                                ${stoppedFmt !== '-' ? `<div><span class="text-zinc-600">S:</span> ${stoppedFmt}</div>` : ''}
                            </td>
                            <td class="p-3 border-b border-zinc-800/50 text-right">
                                ${actionHtml}
                            </td>
                        `;
                            tbody.appendChild(tr);
                            foundApps++;
                        }
                    }
                }

                if (foundApps === 0) {
                    // Try legacy parsing if regex/box fails (fallback)
                    if (lines.length > 2) {
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line || line.startsWith('┏') || line.startsWith('┡') || line.startsWith('└')) continue;
                            const parts = line.split(/\s{2,}/);
                            if (parts.length >= 3) {
                                // Minimal fallback logic
                                foundApps++;
                            }
                        }
                    }

                    if (foundApps === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-zinc-500">No apps found parsing output.</td></tr>`;
                        console.log("Raw output parsing failed:", output);
                    }
                }
            }

            function getStateClass(state) {
                state = state.toLowerCase();
                if (state.includes('deploy') || state.includes('run')) return 'bg-emerald-500/10 text-emerald-500';
                if (state.includes('stop') || state.includes('detach')) return 'bg-zinc-700/50 text-zinc-400';
                if (state.includes('fail') || state.includes('error')) return 'bg-red-500/10 text-red-500';
                return 'bg-blue-500/10 text-blue-500';
            }

            // Auto fetch on load if Web UI is active? 
            // We catch this in showWorkerUI logic if we want.
            // Hook into showWorkerUI to refresh list
            const _originalShowWorkerUI = showWorkerUI;
            showWorkerUI = function (e, workerId) {
                _originalShowWorkerUI(e, workerId);
                // Verify it's local worker
                if (activeWorkerId === workerId) {
                    fetchModalApps();
                    fetchModalProfile();
                }
            };

            // Profile Management
            function fetchModalProfile() {
                if (!activeWorkerId) return;
                socket.emit('exec_command', {
                    worker_id: activeWorkerId,
                    command: `${MODAL_BIN} profile current`,
                    cwd: MODAL_WORK_DIR,
                    id: 'get-profile-current'
                });
            }

            function fetchModalProfiles() {
                if (!activeWorkerId) return;

                // Open modal immediately
                const modal = document.getElementById('profile-modal');
                const content = document.getElementById('profile-modal-content');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });

                document.getElementById('profile-list-container').innerHTML = '<div class="text-center text-zinc-500 py-8"><span class="animate-spin inline-block mr-2">⌛</span> Loading profiles...</div>';

                socket.emit('exec_command', {
                    worker_id: activeWorkerId,
                    command: `${MODAL_BIN} profile list`,
                    cwd: MODAL_WORK_DIR,
                    id: 'list-profiles'
                });
            }

            function closeProfileModal() {
                const modal = document.getElementById('profile-modal');
                const content = document.getElementById('profile-modal-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            function switchModalProfile(profileName) {
                if (!activeWorkerId) return;

                closeProfileModal();
                document.getElementById('current-profile-name').innerHTML = '<span class="animate-pulse">Switching...</span>';

                socket.emit('exec_command', {
                    worker_id: activeWorkerId,
                    command: `${MODAL_BIN} profile activate ${profileName}`,
                    cwd: MODAL_WORK_DIR,
                    id: 'activate-profile'
                });
            }

            // --- Add Profile Modal Logic ---
            function openAddProfileModal() {
                // Hide Profile List Modal
                document.getElementById('profile-modal').classList.add('hidden');
                
                const modal = document.getElementById('add-profile-modal');
                const content = document.getElementById('add-profile-modal-content');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            }

            function closeAddProfileModal() {
                const modal = document.getElementById('add-profile-modal');
                const content = document.getElementById('add-profile-modal-content');
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                // Clear input
                document.getElementById('new-profile-config').value = '';

                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Re-open Profile List Modal
                    fetchModalProfiles();
                }, 200);
            }

            async function saveNewProfile() {
                const configText = document.getElementById('new-profile-config').value;
                
                if (!configText || configText.trim() === '') {
                    alert('Please paste the configuration block.');
                    return;
                }
                
                try {
                    const res = await fetch('/api/config/add_profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            config_text: configText
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok) {
                        alert('Profile added successfully!');
                        closeAddProfileModal(); 
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Network error: ' + e);
                }
            }

            async function deleteProfile(profileName) {
                if (!confirm(`Are you sure you want to delete profile "${profileName}"? This cannot be undone.`)) return;

                try {
                    const res = await fetch('/api/config/delete_profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            profile_name: profileName
                        })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        // refresh list
                        fetchModalProfiles();
                    } else {
                        alert('Error deleting profile: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Network error: ' + e);
                }
            }

            // Balance polling interval reference
            let balanceInterval = null;

            // === AUTO-SYNC USAGE FROM MODAL VOLUME ===
            async function syncUsageFromVolume(silentMode = false) {
                const currentProfile = document.getElementById('current-profile-name').textContent.trim();
                if (!currentProfile || currentProfile === '...' || currentProfile.includes('Loading')) {
                    console.log('[Sync] Skipped - profile not ready');
                    return null;
                }
                
                console.log(`[Sync] Syncing usage for ${currentProfile}...`);
                
                try {
                    const res = await fetch('/sync-usage', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({
                            account_name: currentProfile,
                            volume_name: 'jekverse-comfy-models'
                        })
                    });
                    
                    if (!res.ok) {
                        console.error(`[Sync] HTTP Error: ${res.status} ${res.statusText}`);
                        return null;
                    }
                    
                    const data = await res.json();
                    console.log('[Sync] Response:', data);
                    
                    if (data.synced && data.cost_deducted > 0) {
                        console.log(`[Sync] ✅ Deducted $${data.cost_deducted.toFixed(4)} from ${currentProfile}, new balance: $${data.new_balance}`);
                    } else if (data.synced) {
                        console.log('[Sync] ✅ Synced, no new cost to deduct');
                    }
                    
                    return data;
                } catch (e) {
                    console.error('[Sync] Error:', e);
                    return null;
                }
            }

            function startBalancePolling() {
                // Sync immediately, then fetch balance
                syncUsageFromVolume().then(() => fetchProfileBalance());
                
                // Then poll every 30 seconds with sync
                if (balanceInterval) clearInterval(balanceInterval);
                balanceInterval = setInterval(async () => {
                    await syncUsageFromVolume(true); // silent mode
                    fetchProfileBalance(false, true); // silent mode
                }, 30000); // Poll every 30 seconds (not too frequent)
            }

            function stopBalancePolling() {
                if (balanceInterval) {
                    clearInterval(balanceInterval);
                    balanceInterval = null;
                }
            }

            function fetchProfileBalance(force = false, silent = false) {
                if (!activeWorkerId) return;

                const currentProfile = document.getElementById('current-profile-name').textContent.trim();
                const walletPath = `{{ wallet_dir }}/wallet_${currentProfile}.json`;

                // Visual feedback
                if (!silent) {
                    const container = document.getElementById('profile-balance');
                    const balanceEl = document.getElementById('balance-value');
                    if (container && balanceEl) {
                        container.classList.remove('hidden');
                        container.classList.add('flex');
                        balanceEl.textContent = "..."; // Loading
                    }
                }

                console.log(`[Frontend] Fetching balance for ${currentProfile}`);

                socket.emit('get_balance', {
                    account_name: currentProfile,
                    worker_id: activeWorkerId,
                    id: 'fetch-balance'
                });
            }

            function renderProfilesDisplay(output) {
                const container = document.getElementById('profile-list-container');
                container.innerHTML = '';

                if (!output || output.trim() === '') {
                    container.innerHTML = '<div class="text-center text-zinc-500 py-4">No profiles found.</div>';
                    return;
                }

                const lines = output.trim().split('\n');
                let found = 0;

                // Parse table looking for lines starting with "│"
                // │ • │ riquisinago         │ ...
                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('│')) {
                        const cols = line.split('│').map(c => c.trim());
                        // cols[0] is empty (before first |)
                        // cols[1] is active indicator (• or empty)
                        // cols[2] is profile name
                        if (cols.length >= 3) {
                            const isActive = cols[1] === '•';
                            const name = cols[2];
                            if (name && name !== 'Profile') {
                                const el = document.createElement('div');
                                el.className = `w-full px-4 py-3 rounded-lg mb-1 flex items-center justify-between group transition-colors ${isActive ? 'bg-emerald-500/10 border border-emerald-500/20' : 'hover:bg-zinc-800 border border-transparent cursor-pointer'}`;
                                
                                // Prevent delete click from triggering switch
                                el.onclick = (e) => {
                                    if(e.target.closest('.delete-btn')) return;
                                    if(!isActive) switchModalProfile(name);
                                };

                                el.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <div class="h-8 w-8 rounded-full flex items-center justify-center ${isActive ? 'bg-emerald-500 text-white' : 'bg-zinc-800 text-zinc-400 group-hover:bg-zinc-700'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    </div>
                                    <span class="font-medium ${isActive ? 'text-emerald-400' : 'text-zinc-300 group-hover:text-white'}">${name}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    ${isActive ? '<span class="text-xs text-emerald-500 font-bold uppercase tracking-wider">Active</span>' : ''}
                                    <button onclick="deleteProfile('${name}')" class="delete-btn p-1.5 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 rounded-md transition-all opacity-0 group-hover:opacity-100" title="Delete Profile">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </button>
                                </div>
                             `;
                                container.appendChild(el);
                                found++;
                            }
                        }
                    }
                });

                if (found === 0) {
                    container.innerHTML = '<div class="text-center text-zinc-500 py-4">Failed to parse profile list.</div>';
                    console.log("Raw profile list output:", output);
                }
            }

            // Initialize profile on worker select (re-implement if it was lost)
            function onWorkerSelected(workerId) {
                console.log("Worker selected:", workerId);
                activeWorkerId = workerId;

                // Update empty state visibility
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('web-ui-container').classList.remove('hidden');

                // Hide/Show terminals (hide all first)
                document.querySelectorAll('.terminal-container').forEach(el => el.classList.add('hidden'));

                // Fetch data
                fetchModalApps();
                fetchModalVolumes();
                fetchModalProfile();
            }

        </script>

        <!-- Config Modal -->
        <div id="config-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-2xl w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
                id="config-modal-content">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                        </path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Server Configuration
                </h3>

                <div class="flex items-center gap-4 mb-6 border-b border-zinc-700/50">
                    <button onclick="switchConfigTab('server')" id="tab-btn-server" class="pb-2 border-b-2 border-emerald-500 text-emerald-400 font-medium text-sm transition-colors">
                        Server Configuration
                    </button>
                    <button onclick="switchConfigTab('restore')" id="tab-btn-restore" class="pb-2 border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 font-medium text-sm transition-colors">
                        Restore Model Configuration
                    </button>
                </div>

                <!-- Tab 1: Server Config -->
                <div id="tab-content-server" class="block">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Template (Full Width) -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Template</label>
                        <select id="config-template" onchange="applyTemplate(this)"
                            class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                            <option value="">Select a Template...</option>
                            <option value="CPU-JKT">CPU-JKT (Jakarta / CPU)</option>
                            <option value="T4-Light">T4-Light (Cost Effective)</option>
                            <option value="H100-Mid">H100-Mid (High Performance)</option>
                            <option value="H200-Heavy">H200-Heavy (Very High Performance)</option>
                            <option value="B200-Beast">B200-Beast (Extreme Performance)</option>
                        </select>
                    </div>

                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">App
                                Name</label>
                            <input type="text" id="config-app-name" value="modal_app"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">GPU
                                Type</label>
                            <select id="config-gpu-type" onchange="handleGpuChange(this)"
                                onfocus="this.dataset.prev = this.value; previousGpu = this.value;"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                <option value="CPU">CPU Only</option>
                                <option value="T4">T4 (Cheap, Good for Inference)</option>
                                <option value="L4">L4 (Efficient)</option>
                                <option value="A10">A10 (Balanced)</option>
                                <option value="L40S">L40S (Powerful)</option>
                                <option value="H100">H100 (High Performance)</option>
                                <option value="H200" selected>H200 (The Beast)</option>
                                <option value="B200">B200 (Latest)</option>
                            </select>
                        </div>

                        <div>
                            <label
                                class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Timeout</label>
                            <select id="config-timeout"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                <option value="1800">30 Minutes</option>
                                <option value="3600">1 Hour</option>
                                <option value="7200">2 Hours</option>
                                <option value="10800">3 Hours</option>
                                <option value="86400" selected>24 Hours</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Storage</label>
                            <select id="config-storage"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                <option value="" selected>512GB (Default)</option>
                                <option value="1048576">1TB</option>
                                <option value="2097152">2TB</option>
                            </select>
                        </div>

                        <div>
                            <label
                                class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Region</label>
                            <select id="config-region" onchange="handleRegionChange(this)"
                                onfocus="this.dataset.prev = this.value; previousRegion = this.value;"
                                class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                <option value="" selected>Select Default Region</option>
                                <option value="ap-southeast-3">AWS Jakarta</option>
                                <option value="asia-southeast1">GCP Singapore</option>
                                <option value="southeastasia">Azure Singapore</option>
                                <option value="malaysiawest">Azure Kuala Lumpur</option>
                            </select>
                        </div>

                        <div>
                             <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Select Modal Image</label>
                             <select id="config-image" class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                 <option value="app.py" selected>app.py (Default)</option>
                             </select>
                        </div>
                    </div>
                </div>
                </div> <!-- End Tab 1 -->

                <!-- Tab 2: Restore Model Config -->
                <div id="tab-content-restore" class="hidden">
                     <div class="space-y-4">
                        <!-- Generator Section (Moved to Top) -->
                        <div>
                             <h4 class="text-xs font-bold text-emerald-400 uppercase tracking-wide mb-3">Generate New Restore Script</h4>
                             
                             <!-- Script Name -->
                             <div class="mb-3">
                                <label class="block text-[10px] font-medium text-zinc-500 mb-1 uppercase">Script Name</label>
                                <input type="text" id="gen-script-name" placeholder="my_restore_script" class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-1.5 px-3 text-sm text-gray-200 focus:outline-none focus:border-emerald-500 font-mono">
                             </div>
                             
                             <!-- Rows Container -->
                             <div class="max-h-60 overflow-y-auto custom-scrollbar mb-3 space-y-2 pr-1" id="gen-rows-container">
                                 <!-- Initial Row -->
                                 <div class="gen-row grid grid-cols-12 gap-2 items-end">
                                     <div class="col-span-7">
                                         <label class="block text-[10px] font-medium text-zinc-500 mb-1">URL</label>
                                         <input type="text" placeholder="https://huggingface.co/..." class="gen-url w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500">
                                     </div>
                                     <div class="col-span-4">
                                         <label class="block text-[10px] font-medium text-zinc-500 mb-1">Diff Dir</label>
                                         <select class="gen-dir w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500 font-mono">
                                             <option value="checkpoints">checkpoints</option>
                                             <option value="diffusion_models">diffusion_models</option>
                                             <option value="vae">vae</option>
                                             <option value="loras">loras</option>
                                             <option value="text_encoders">text_encoders</option>
                                             <option value="controlnet">controlnet</option>
                                             <option value="upscale_models">upscale_models</option>
                                             <option value="embeddings">embeddings</option>
                                             <option value="clip">clip</option>
                                             <option value="unet">unet</option>
                                             <option value="clip_vision">clip_vision</option>
                                         </select>
                                     </div>
                                     <div class="col-span-1 flex justify-center pb-1">
                                          <!-- First row non-deletable -->
                                     </div>
                                 </div>
                             </div>
                             
                             <!-- Actions -->
                             <div class="flex gap-2">
                                 <button onclick="addGenRow()" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs rounded transition-colors border border-zinc-700">+ Add Row</button>
                                 <div class="flex-1"></div>
                                 <button onclick="generateRestoreScript()" class="px-3 py-1.5 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 text-xs font-medium rounded transition-colors border border-emerald-500/30">Generate Script</button>
                             </div>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-zinc-800 my-4"></div>

                        <!-- Select Image Section (Moved to Bottom) -->
                        <div>
                             <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Select Restore Model Image</label>
                             <select id="config-restore-image" class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all">
                                 <option value="">Loading restore images...</option>
                             </select>
                             <p class="text-[10px] text-zinc-500 mt-1">Select a python script from <code>modal-app-manager/images/restore_model/</code></p>
                        </div>
                     </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button onclick="closeConfigModal()"
                        class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">Cancel</button>
                    <button onclick="saveConfigModal()"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20">Save</button>
                </div>
            </div>
        </div>

        <!-- Create Volume Modal -->
        <div id="create-volume-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
                id="create-volume-modal-content">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Create New Volume
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Volume Name</label>
                        <input type="text" id="create-volume-name"
                            placeholder="e.g. my-models"
                            class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono">
                        <p class="text-[10px] text-zinc-500 mt-1">Only letters, numbers, dashes, and underscores allowed.</p>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button onclick="closeCreateVolumeModal()"
                        class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">Cancel</button>
                    <button onclick="createModalVolume()" id="btn-create-volume-confirm"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20">
                        Create
                    </button>
            </div>
        </div>
        </div>

        <!-- Delete Volume Confirmation Modal -->
        <div id="delete-volume-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
                id="delete-volume-modal-content">
                <h3 class="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    Confirm Deletion
                </h3>

                <p class="text-zinc-400 text-sm mb-6">
                    Are you sure you want to delete volume <span id="delete-volume-target" class="text-white font-mono break-all font-medium"></span>?
                    <br><span class="text-red-400/80 text-xs mt-1 block">This action cannot be undone.</span>
                </p>

                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteVolumeModal()"
                        class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">Cancel</button>
                    <button onclick="confirmDeleteModalVolume()" id="btn-delete-volume-confirm"
                        class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-500 text-sm font-medium rounded-lg transition-colors shadow-lg shadow-red-900/10">
                        Delete Volume
                    </button>
                </div>
            </div>
        </div>

        <!-- Volume Inspector Modal -->
        <div id="volume-inspector-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-4xl w-full flex flex-col max-h-[85vh] shadow-2xl transform scale-95 transition-transform duration-200"
                id="volume-inspector-modal-content">
                
                <!-- Header -->
                <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50 rounded-t-xl">
                    <div class="flex flex-col min-w-0">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            <span id="volume-inspector-title">Volume Details</span>
                        </h3>
                        <div class="flex items-center gap-2 text-xs font-mono text-zinc-400 mt-1">
                             <span class="text-emerald-500">path:</span>
                             <span id="volume-inspector-path" class="truncate">/</span>
                        </div>
                    </div>
                     <button onclick="closeVolumeInspector()" class="p-1.5 text-zinc-400 hover:text-white rounded hover:bg-zinc-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-auto bg-zinc-950/30 p-2">
                     <div class="mb-2">
                        <button id="volume-inspector-back" onclick="volumeInspectorUp()" class="hidden flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded transition-colors w-full text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg>
                            .. (Parent Directory)
                        </button>
                     </div>
                     <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-zinc-500 uppercase font-medium border-b border-zinc-800/50">
                            <tr>
                                <th class="p-2 w-8"></th>
                                <th class="p-2">Name</th>
                                <th class="p-2 w-24">Size</th>
                                <th class="p-2 w-32">Modified</th>
                            </tr>
                        </thead>
                        <tbody id="volume-inspector-list" class="text-sm font-mono text-zinc-300 divide-y divide-zinc-800/30">
                            <!-- Items go here -->
                        </tbody>
                     </table>
                </div>
            </div>
        </div>

        <!-- Delete File Confirmation Modal -->
        <div id="delete-file-modal"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
                id="delete-file-modal-content">
                <h3 class="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    Confirm Deletion
                </h3>

                <p class="text-zinc-400 text-sm mb-6">
                    Delete <span id="delete-file-target" class="text-white font-mono break-all font-medium"></span>?
                    <br><span class="text-red-400/80 text-xs mt-1 block">This cannot be undone.</span>
                </p>

                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteFileModal()"
                        class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">Cancel</button>
                    <button onclick="confirmDeleteFile()" id="btn-delete-file-confirm"
                        class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-500 text-sm font-medium rounded-lg transition-colors shadow-lg shadow-red-900/10">
                        Delete
                    </button>
                </div>
            </div>
        </div>


        <!-- Profile Selection Modal (Existing) -->
        <div id="profile-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col max-h-[80vh]"
                id="profile-modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Select Profile</h3>
                    <div class="flex gap-2">
                        <button onclick="openAddProfileModal()" class="text-emerald-500 hover:text-emerald-400 text-sm font-medium transition-colors border border-emerald-500/20 bg-emerald-500/10 px-2 py-1 rounded">
                            + Add Profile
                        </button>
                        <button onclick="closeProfileModal()" class="text-zinc-500 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto pr-2" id="profile-list-container">
                    <!-- Profiles injected here -->
                    <div class="text-center text-zinc-500 py-8">Loading profiles...</div>
                </div>
            </div>
        </div>

        <!-- Add Profile Modal -->
        <div id="add-profile-modal"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
                id="add-profile-modal-content">
                <h3 class="text-lg font-semibold text-white mb-4">Add Modal Profile</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Profile Configuration</label>
                        <p class="text-[10px] text-zinc-500 mb-2">Paste your full profile configuration block here:</p>
                        <textarea id="new-profile-config" rows="6" placeholder="[my-profile]&#10;token_id = &quot;ak-...&quot;&#10;token_secret = &quot;as-...&quot;"
                            class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-xs text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono resize-none"></textarea>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button onclick="closeAddProfileModal()"
                        class="px-4 py-2 text-sm text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button onclick="saveNewProfile()"
                        class="px-6 py-2 text-sm bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded-lg shadow-lg shadow-emerald-900/20 transition-all">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Wallet Logs Modal -->
        <div id="wallet-logs-modal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-2xl w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col max-h-[80vh]"
                id="wallet-logs-modal-content">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-emerald-500/10 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Wallet Logs</h3>
                            <div class="flex items-center gap-2">
                                <p class="text-xs text-zinc-500 font-mono" id="wallet-logs-account">Account: ...</p>
                                <button onclick="fetchWalletLogs()" class="p-1 text-zinc-500 hover:text-emerald-400 transition-colors" title="Refresh Logs">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeWalletLogs()" class="text-zinc-500 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <!-- Table Container -->
                <div class="flex-1 overflow-auto bg-zinc-950/50 rounded-lg border border-zinc-800 custom-scrollbar">
                     <table class="w-full text-left border-collapse">
                        <thead class="bg-zinc-900/50 sticky top-0 z-10 text-xs text-zinc-500 uppercase font-medium">
                            <tr>
                                <th class="p-3 border-b border-zinc-800">Start Time</th>
                                <th class="p-3 border-b border-zinc-800">GPU</th>
                                <th class="p-3 border-b border-zinc-800">Duration</th>
                                <th class="p-3 border-b border-zinc-800 text-right">Cost</th>
                                <th class="p-3 border-b border-zinc-800 text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="wallet-logs-table-body" class="text-sm text-zinc-300 font-mono divide-y divide-zinc-800/50">
                            <tr><td colspan="4" class="p-6 text-center text-zinc-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Footer -->
                <div class="mt-4 pt-3 border-t border-zinc-800 flex justify-between items-center text-xs text-zinc-500 shrink-0">
                    <span id="wallet-logs-total-sessions">Sessions: 0</span>
                    <span id="wallet-logs-total-cost">Total Spend: $0.00</span>
                </div>
            </div>
        </div>

    </div>
    <!-- End Content Wrapper -->

    <!-- ... (Tab Context Menu existing code) ... -->
    <div id="tab-context-menu"
        class="fixed hidden bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-[100] py-1 w-32 animate-fade-in transition-opacity duration-200">
        <!-- ... existing menu items ... -->
        <button onclick="handleTabRename()"
            class="w-full text-left px-3 py-1.5 text-xs text-zinc-300 hover:bg-zinc-800 hover:text-white flex items-center gap-2">
            Rename
        </button>
        <div class="h-px bg-zinc-800 my-1"></div>
        <button onclick="handleTabDelete()"
            class="w-full text-left px-3 py-1.5 text-xs text-red-400 hover:bg-zinc-800 hover:text-red-300 flex items-center gap-2">
            Delete
        </button>
    </div>

    <script>
        // ... (Existing variables) ...

        // Wallet Logs Logic
        function openWalletLogs() {
             const modal = document.getElementById('wallet-logs-modal');
             const content = document.getElementById('wallet-logs-modal-content');
             const profileName = document.getElementById('current-profile-name').textContent.trim();
             
             document.getElementById('wallet-logs-account').textContent = `Account: ${profileName}`;

             modal.classList.remove('hidden');
             requestAnimationFrame(() => {
                 modal.classList.remove('opacity-0');
                 content.classList.remove('scale-95');
                 content.classList.add('scale-100');
             });

             fetchWalletLogs();
        }

        function closeWalletLogs() {
             const modal = document.getElementById('wallet-logs-modal');
             const content = document.getElementById('wallet-logs-modal-content');
             modal.classList.add('opacity-0');
             content.classList.remove('scale-100');
             content.classList.add('scale-95');
             setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function fetchWalletLogs() {
            if (!activeWorkerId) return;

             const currentProfile = document.getElementById('current-profile-name').textContent.trim();
             const tbody = document.getElementById('wallet-logs-table-body');
             tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-zinc-500"><span class="animate-spin inline-block mr-2">⌛</span> Fetching logs...</td></tr>`;

             socket.emit('get_balance', {
                account_name: currentProfile,
                worker_id: activeWorkerId,
                id: 'fetch-wallet-logs'
            });
        }

        function renderWalletLogs(walletData) {
            const tbody = document.getElementById('wallet-logs-table-body');
            tbody.innerHTML = '';
            
            if (!walletData || !walletData.history || walletData.history.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-zinc-500">No history found.</td></tr>`;
                 return;
            }
            
            // Reverse history to show newest first
            const history = [...walletData.history].reverse();
            let totalCost = 0;

            // Identify active sessions
            const activeSessionIds = new Set();
            if (walletData.sessions) {
                 const now = Date.now() / 1000;
                 for (const [sid, ts] of Object.entries(walletData.sessions)) {
                     if ((now - ts) < 60) {
                         activeSessionIds.add(sid);
                     }
                 }
            }

            // Calculate running balance from history
            let runningBalance = walletData.balance || 0;
            
            // First pass: calculate total cost and identify completed sessions
            totalCost = 0;
            const completedSessionIds = new Set();
            history.forEach(entry => {
                totalCost += parseFloat(entry.cost || entry.total_cost || 0);
                // If any entry for this session is 'completed', the session is done
                if (entry.status === 'completed' && entry.session_id) {
                    completedSessionIds.add(entry.session_id);
                }
            });

            // Re-calculate: start from balance + totalCost (what it was before all deductions)
            // Then subtract as we go through (newest first)
            const balanceBeforeAll = runningBalance + totalCost;
            let balanceTracker = runningBalance; // Start from current and add back

            // Track which session IDs have been displayed as "running" 
            // Only the FIRST (newest) occurrence should glow, and ONLY if not completed
            const displayedRunningSessionIds = new Set();

            history.forEach((entry, idx) => {
                // Format start time to be readable - use Asia/Jakarta timezone
                let start = '-';
                if (entry.start_time) {
                    try {
                        const d = new Date(entry.start_time);
                        start = d.toLocaleString('id-ID', { 
                            timeZone: 'Asia/Jakarta',
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: false
                        });
                    } catch (e) {
                        start = entry.start_time;
                    }
                }
                
                // Duration: use duration_sec OR total_duration_sec
                let duration = '-';
                const durationSec = entry.duration_sec || entry.total_duration_sec;
                if (durationSec) {
                    const sec = Math.round(durationSec);
                    const h = Math.floor(sec / 3600);
                    const m = Math.floor((sec % 3600) / 60);
                    const s = sec % 60;
                    
                    const parts = [];
                    if (h > 0) parts.push(`${h}h`);
                    if (m > 0) parts.push(`${m}m`);
                    parts.push(`${s}s`);
                    duration = parts.join(' ');
                }
                
                // Cost from entry.cost OR entry.total_cost
                const entryCost = parseFloat(entry.cost || entry.total_cost || 0);
                const cost = entryCost.toFixed(4);
                
                // Balance after this entry: work backwards from current
                // Since history is reversed (newest first), idx 0 = current balance
                // idx 1 = current + cost[0], etc.
                const balanceAfter = balanceTracker.toFixed(4);
                balanceTracker += entryCost; // Add back for next older entry
                
                let gpu = entry.gpu_type || '-';
                
                // Determine if this entry should show as "running"
                // Only mark as running if: 
                // 1. Entry status is 'running'
                // 2. Session is NOT completed (no 'completed' entry exists for this session)
                // 3. This is the first/newest occurrence for this session_id
                let isActiveEntry = false;
                if (entry.status === 'running' && entry.session_id) {
                    const isNotCompleted = !completedSessionIds.has(entry.session_id);
                    const isFirstOccurrence = !displayedRunningSessionIds.has(entry.session_id);
                    if (isNotCompleted && isFirstOccurrence) {
                        isActiveEntry = true;
                        displayedRunningSessionIds.add(entry.session_id);
                    }
                }
                
                // Show short session ID if available
                if (entry.session_id && entry.session_id !== 'default') {
                    const shortSid = entry.session_id.substring(0, 7);
                    
                    let tagClass = "bg-zinc-800 border-zinc-700 text-zinc-500";
                    // Active indicator ONLY for the first/newest running entry
                    if (isActiveEntry) {
                         tagClass = "bg-emerald-500/10 border-emerald-500/50 text-emerald-400 shadow-[0_0_8px_rgba(16,185,129,0.2)] animate-pulse";
                    }

                    gpu += ` <span class="ml-1 text-[10px] px-1 py-0.5 rounded border font-mono transition-all ${tagClass}" title="${entry.session_id}">#${shortSid}</span>`;
                }

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-zinc-800/30 transition-colors';
                
                // Active Session Logic - only for the first running entry
                let firstCellClass = 'p-3 border-b border-zinc-800/50 whitespace-nowrap';

                if (isActiveEntry) {
                    tr.className += ' bg-emerald-900/10';
                    firstCellClass += ' border-l-2 border-l-emerald-500';
                } else {
                    firstCellClass += ' border-l-2 border-l-transparent';
                }

                tr.innerHTML = `
                    <td class="${firstCellClass}">${start}</td>
                    <td class="p-3 border-b border-zinc-800/50 text-zinc-400 font-bold flex items-center">${gpu}</td>
                    <td class="p-3 border-b border-zinc-800/50 text-zinc-400">${duration}</td>
                    <td class="p-3 border-b border-zinc-800/50 text-right text-emerald-400/80">-$${cost}</td>
                    <td class="p-3 border-b border-zinc-800/50 text-right text-zinc-300">$${balanceAfter}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update Summary
            document.getElementById('wallet-logs-total-sessions').textContent = `Sessions: ${history.length}`;
            document.getElementById('wallet-logs-total-cost').textContent = `Total Spend: $${totalCost.toFixed(4)}`;
        }
    </script>
    <script>
        // ...Existing script block continues...
        
        // UPDATE socket.on('exec_result') to handle 'fetch-wallet-logs'
        // Since we can't easily patch inside the big socket.on block with replace_file_content safely without context,
        // We will append a listener extension logic OR assume the specialized get_balance handler is generic.
        // Wait, get_balance handler in JS is inside socket.on('exec_result'). 
        
        // I need to insert the case 'fetch-wallet-logs' into the existing exec_result handler.
    </script>

    <script>
        // Context Menu State
        let contextMenuTarget = null; // {workerId, sessionId}
        const contextMenu = document.getElementById('tab-context-menu');

        // Close Menu on Click Elsewhere
        document.addEventListener('click', () => {
            contextMenu.classList.add('hidden');
        });

        // Also close on scroll inside terminal wrappers
        // document.querySelectorAll('.terminal-wrapper').forEach(el => el.addEventListener('scroll', () => contextMenu.classList.add('hidden')));

        function showTabContextMenu(e, workerId, sessionId) {
            e.preventDefault();
            e.stopPropagation(); // Stop bubbling

            contextMenuTarget = { workerId, sessionId };

            // Position Menu
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;

            // Show
            contextMenu.classList.remove('hidden');
        }

        function handleTabRename() {
            if (!contextMenuTarget) return;
            const { workerId, sessionId } = contextMenuTarget;

            // For now using prompt, can be upgraded to modal later
            const tabBtn = document.getElementById(`tab-btn-${workerId}-${sessionId}`);
            const currentName = tabBtn.querySelector('.truncate').textContent;

            const newName = prompt('Rename Terminal Tab:', currentName);
            if (newName && newName.trim() !== '') {
                tabBtn.querySelector('.truncate').textContent = newName.trim();
            }
        }

        function handleTabDelete() {
            if (!contextMenuTarget) return;
            const { workerId, sessionId } = contextMenuTarget;
            closeSession(null, workerId, sessionId); // Existing function
        }
        // Swipe Gesture for Mobile Sidebar
        let touchStartX = 0;
        let touchStartY = 0;
        let ignoreSwipe = false;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;

            // Ignore swipes inside scrollable table containers or Code Editor to prevent conflict
            if (e.target.closest('.overflow-x-auto') || e.target.closest('table') || e.target.closest('#file-editor')) {
                ignoreSwipe = true;
            } else {
                ignoreSwipe = false;
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (ignoreSwipe) return;

            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;

            handleSwipeGesture(touchStartX, touchStartY, touchEndX, touchEndY);
        }, { passive: true });

        function handleSwipeGesture(startX, startY, endX, endY) {
            // Only enable on Mobile (< 768px)
            if (window.innerWidth >= 768) return;

            const diffX = endX - startX;
            const diffY = Math.abs(endY - startY);

            // Swipe Right (Open Sidebar) - Open 'code-editor' (changed from remote-terminal)
            // Relaxed: No startX constraint (removed startX < 50)
            if (diffX > 50 && diffY < 50) {
                if (sidePanel.classList.contains('w-0')) {
                    toggleSidePanel('code-editor');
                }
            }

            // Swipe Left (Close Sidebar) - If sidebar is open
            if (diffX < -50 && diffY < 50) {
                if (!sidePanel.classList.contains('w-0')) {
                    closeSidePanel();
                }
            }
        }
    </script>


    <!-- Custom Confirm Modal -->
    <div id="confirm-modal"
        class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
            id="confirm-modal-content">
            <h3 class="text-lg font-semibold text-white mb-2">Confirm Action</h3>
            <p id="confirm-modal-message" class="text-zinc-400 text-sm mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirmModal()"
                    class="px-4 py-2 text-sm text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="confirm-modal-btn"
                    class="px-4 py-2 text-sm bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white rounded-lg transition-all font-medium">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logs-modal" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeLogsModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="logs-modal-content"
                class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                    <h3 id="logs-title" class="text-lg font-medium text-white">App Logs</h3>
                    <button onclick="closeLogsModal()" class="text-zinc-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="p-0 flex-1 overflow-auto bg-black/50 min-h-0">
                    <pre id="logs-pre"
                        class="w-full min-h-full p-4 text-xs font-mono text-zinc-300 whitespace-pre-wrap"></pre>
                </div>
                <div class="p-4 border-t border-zinc-800 flex justify-end">
                    <button onclick="closeLogsModal()"
                        class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded text-sm transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-95 transition-transform duration-200"
            id="user-profile-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Edit Profile
                </h3>
                <button onclick="closeUserProfileModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-zinc-800 mb-6">
                <button onclick="switchProfileTab('general')" id="tab-general"
                    class="px-4 py-2 text-sm font-medium text-emerald-400 border-b-2 border-emerald-500 transition-colors">
                    General
                </button>
                <button onclick="switchProfileTab('security')" id="tab-security"
                    class="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-zinc-200 border-b-2 border-transparent transition-colors">
                    Security
                </button>
            </div>

            <!-- General Tab -->
            <div id="profile-tab-general" class="space-y-4">
                <div>
                    <div>
                        <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Avatar
                            Image</label>
                        <div class="flex gap-3 items-center">
                            <img id="profile-avatar-preview" src="{{ current_user.avatar_url }}"
                                class="w-10 h-10 rounded-full bg-zinc-800 object-cover border border-zinc-700 flex-shrink-0">
                            <input type="file" id="profile-avatar-input" accept="image/*"
                                class="flex-1 block w-full text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-zinc-800 file:text-emerald-400 hover:file:bg-zinc-700 transition-all cursor-pointer">
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Username</label>
                        <input type="text" id="profile-username" value="{{ current_user.username }}"
                            class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono">
                    </div>
                    <div class="pt-2 flex justify-end">
                        <button onclick="saveProfileGeneral()"
                            class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
            <div id="profile-tab-security" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">Current
                        Password</label>
                    <input type="password" id="profile-current-pass"
                        class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono"
                        placeholder="Required to set new password">
                </div>
                <div class="pt-2 border-t border-zinc-800">
                    <label class="block text-xs font-medium text-zinc-400 mb-1.5 uppercase tracking-wide">New
                        Password</label>
                    <input type="password" id="profile-new-pass"
                        class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono mb-2"
                        placeholder="New Password">
                    <input type="password" id="profile-confirm-pass"
                        class="w-full bg-zinc-950/50 border border-zinc-700 rounded-lg py-2 px-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all font-mono"
                        placeholder="Confirm New Password">
                </div>
                <div class="pt-2 flex justify-end">
                    <button onclick="saveProfilePassword()"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-900/20">
                        Update Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Profile Dropdown Logic
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profile-menu');
            const btn = e.target.closest('button');
            // If click is outside menu AND not on the toggle button
            if (!menu.contains(e.target) && (!btn || !btn.onclick || !btn.onclick.toString().includes('toggleProfileMenu'))) {
                menu.classList.add('hidden');
            }
        });

        // Logout Logic
        function openLogoutModal() {
            document.getElementById('profile-menu').classList.add('hidden');
            showConfirmModal(
                "Are you sure you want to sign out?",
                () => window.location.href = '/logout'
            );
        }

        // Profile Modal Logic
        function openProfileModal() {
            document.getElementById('profile-menu').classList.add('hidden');
            const modal = document.getElementById('user-profile-modal');
            const content = document.getElementById('user-profile-modal-content');

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });

            // Reset fields
            document.getElementById('profile-current-pass').value = '';
            document.getElementById('profile-new-pass').value = '';
            document.getElementById('profile-confirm-pass').value = '';
            switchProfileTab('general');

            // Update preview on input logic
            document.getElementById('profile-avatar-input').onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('profile-avatar-preview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function closeUserProfileModal() {
            const modal = document.getElementById('user-profile-modal');
            const content = document.getElementById('user-profile-modal-content');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function switchProfileTab(tab) {
            const genTab = document.getElementById('profile-tab-general');
            const secTab = document.getElementById('profile-tab-security');
            const genBtn = document.getElementById('tab-general');
            const secBtn = document.getElementById('tab-security');

            if (tab === 'general') {
                genTab.classList.remove('hidden');
                secTab.classList.add('hidden');
                genBtn.className = "px-4 py-2 text-sm font-medium text-emerald-400 border-b-2 border-emerald-500 transition-colors";
                secBtn.className = "px-4 py-2 text-sm font-medium text-zinc-400 hover:text-zinc-200 border-b-2 border-transparent transition-colors";
            } else {
                genTab.classList.add('hidden');
                secTab.classList.remove('hidden');
                secBtn.className = "px-4 py-2 text-sm font-medium text-emerald-400 border-b-2 border-emerald-500 transition-colors";
                genBtn.className = "px-4 py-2 text-sm font-medium text-zinc-400 hover:text-zinc-200 border-b-2 border-transparent transition-colors";
            }
        }

        async function saveProfileGeneral() {
            const username = document.getElementById('profile-username').value;
            const fileInput = document.getElementById('profile-avatar-input');
            const file = fileInput.files[0];

            const formData = new FormData();
            formData.append('username', username);
            if (file) {
                formData.append('avatar', file);
            }

            try {
                const res = await fetch('/api/profile/update', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert("Profile updated! Refresh to see changes.");
                    closeUserProfileModal();
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert("Error: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                alert("Network error: " + e);
            }
        }

        async function saveProfilePassword() {
            const currentPass = document.getElementById('profile-current-pass').value;
            const newPass = document.getElementById('profile-new-pass').value;
            const confirmPass = document.getElementById('profile-confirm-pass').value;

            if (!currentPass) return alert("Current password is required.");
            if (!newPass) return alert("New password is required.");
            if (newPass !== confirmPass) return alert("New passwords do not match.");

            try {
                const res = await fetch('/api/profile/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPass, new_password: newPass })
                });

                if (res.ok) {
                    alert("Password updated successfully!");
                    closeUserProfileModal();
                } else {
                    const data = await res.json();
                    alert("Error: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                alert("Network error: " + e);
            }
        }

            // --- Code Editor Logic ---
            let currentOpenFile = null;
            let editor = null;

            function toggleFloatingCursors() {
                const el = document.getElementById('floating-cursor-controls');
                const btn = document.getElementById('btn-cursor-controls');
                if (el.classList.contains('hidden')) {
                     el.classList.remove('hidden');
                     // Highlight button
                     if(btn) btn.classList.add('text-white', 'bg-zinc-800');
                } else {
                     el.classList.add('hidden');
                     if(btn) btn.classList.remove('text-white', 'bg-zinc-800');
                }
            }

            function editorMove(direction) {
                if (!editor) return;
                editor.focus();
                const sel = editor.getSelection();
                switch(direction) {
                    case 'up': editor.navigateUp(1); break;
                    case 'down': editor.navigateDown(1); break;
                    case 'left': editor.navigateLeft(1); break;
                    case 'right': editor.navigateRight(1); break;
                }
                editor.scrollToLine(editor.getCursorPosition().row, true, true, function(){});
            }

            function initCodeEditor() {
                panelHeaderText.textContent = 'CODE EDITOR';
                if(!editor) {
                    // Initialize Ace
                    ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/'); 
                    editor = ace.edit("file-editor");
                    editor.setTheme("ace/theme/twilight");
                    editor.setShowPrintMargin(false);
                    editor.setFontSize(14);
                    editor.setReadOnly(true);
                    
                    editor.session.on('change', function(delta) {
                        if (!editor.getReadOnly()) {
                            document.getElementById('editor-unsaved').classList.remove('hidden');
                        }
                    });
                }
                fetchFiles();
            }

            let currentExplorerPath = '';

            function fetchFiles(path = '') {
                const list = document.getElementById('file-list');
                list.innerHTML = '<li class="text-center text-zinc-600 text-xs py-4">Loading...</li>';
                
                currentExplorerPath = path;

                fetch(`/api/fs/list?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(data => {
                    if(data.error) {
                        list.innerHTML = `<li class="text-center text-red-500 text-xs py-2">Error: ${data.error}</li>`;
                        return;
                    }
                    // Sort: Directories first, then files
                    const sortedFiles = data.files.sort((a, b) => {
                        if (a.type === b.type) return a.name.localeCompare(b.name);
                        return a.type === 'directory' ? -1 : 1;
                    });
                    renderFileList(sortedFiles, path);
                })
                .catch(err => {
                    list.innerHTML = `<li class="text-center text-red-500 text-xs py-2">Failed to load</li>`;
                    console.error(err);
                });
            }

            function renderFileList(files, currentPath) {
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                
                // Add Back Button if not in root
                if (currentPath && currentPath !== '' && currentPath !== '.') {
                     const li = document.createElement('li');
                     li.className = 'group flex items-center gap-2 p-2 rounded hover:bg-zinc-800 cursor-pointer text-zinc-500 hover:text-white transition-colors border-b border-zinc-800/50 mb-1';
                     li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        <span class="text-sm font-medium">..</span>
                     `;
                     // Go up one level
                     const parts = currentPath.split('/');
                     parts.pop();
                     const parentPath = parts.join('/');
                     li.onclick = () => fetchFiles(parentPath);
                     list.appendChild(li);
                }

                if (files.length === 0) {
                    const li = document.createElement('li');
                    li.innerHTML = '<div class="text-center text-zinc-600 text-xs py-4">No files found</div>';
                    list.appendChild(li);
                    return;
                }
                
                files.forEach(file => {
                     const li = document.createElement('li');
                     li.className = 'group flex items-center gap-2 p-2 rounded hover:bg-zinc-800 cursor-pointer text-zinc-400 hover:text-white transition-colors ' + (file.type === 'directory' ? 'text-zinc-300 font-medium' : '');
                     
                     if (file.type === 'file') {
                        li.onclick = () => openFile(file.path);
                     } else if (file.type === 'directory') {
                        li.onclick = () => fetchFiles(file.path);
                     }
                     
                     let icon = '';
                     if (file.type === 'directory') {
                         icon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;
                     } else {
                         icon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
                     }

                     li.innerHTML = `
                        ${icon}
                         <span class="text-sm truncate flex-1">${file.name}</span>
                         
                         <!-- Context Menu -->
                         <div class="relative">
                             <button onclick="toggleContextMenu(event, 'menu-${file.name.replace(/\W/g, '-')}')" class="p-1 hover:bg-zinc-700 rounded text-zinc-500 hover:text-white transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                             </button>
                             <div id="menu-${file.name.replace(/\W/g, '-')}" class="context-menu hidden absolute right-0 top-full mt-1 w-32 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 overflow-hidden">
                                 <button onclick="event.stopPropagation(); renameItem('${file.path}', '${file.name}')" class="w-full text-left px-3 py-2 text-xs text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors flex items-center gap-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                     Rename
                                 </button>
                                 <button onclick="event.stopPropagation(); deleteItem('${file.path}')" class="w-full text-left px-3 py-2 text-xs text-red-500 hover:text-red-400 hover:bg-zinc-800 transition-colors flex items-center gap-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                     Delete
                                 </button>
                             </div>
                         </div>
                      `;
                     list.appendChild(li);
                });
            }

            function createNewItem(type) {
                const name = prompt(`Enter name for new ${type}:`);
                if (!name) return;
                
                // Prefix with current path
                const fullPath = currentExplorerPath ? `${currentExplorerPath}/${name}` : name;
                
                fetch('/api/fs/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: fullPath, type: type })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                         fetchFiles(currentExplorerPath);
                         if(type === 'file') openFile(fullPath);
                    } else {
                        alert('Error creating item: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Network error');
                    console.error(err);
                });
            }
            
            function getModeFromPath(path) {
                const ext = path.split('.').pop().toLowerCase();
                const modes = {
                    'py': 'ace/mode/python',
                    'js': 'ace/mode/javascript',
                    'html': 'ace/mode/html',
                    'css': 'ace/mode/css',
                    'json': 'ace/mode/json',
                    'md': 'ace/mode/markdown',
                    'sh': 'ace/mode/sh',
                    'yml': 'ace/mode/yaml',
                    'yaml': 'ace/mode/yaml'
                };
                return modes[ext] || 'ace/mode/text';
                return modes[ext] || 'ace/mode/text';
            }

            function renameItem(path, oldName) {
                const newName = prompt('Rename to:', oldName);
                if (!newName || newName === oldName) return;
                
                // Construct new path
                const parts = path.split('/');
                parts.pop();
                const parentPath = parts.join('/');
                const newPath = parentPath ? `${parentPath}/${newName}` : newName;
                
                fetch('/api/fs/rename', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_path: path, new_path: newPath })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        fetchFiles(currentExplorerPath);
                    } else {
                        alert('Rename failed: ' + data.error);
                    }
                });
            }

            function deleteItem(path) {
                if (!confirm(`Delete '${path}'? This cannot be undone.`)) return;
                
                fetch('/api/fs/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: path })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        fetchFiles(currentExplorerPath);
                        // If deleted file was open, clear it (optional, skipping for now)
                    } else {
                        alert('Delete failed: ' + data.error);
                    }
                });
            }

            function toggleContextMenu(e, id) {
                e.stopPropagation();
                // Close all other menus
                document.querySelectorAll('.context-menu').forEach(el => {
                    if (el.id !== id) el.classList.add('hidden');
                });
                const menu = document.getElementById(id);
                menu.classList.toggle('hidden');
                
                // Close on click elsewhere
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: true, capture: true }); // Capture to run before other clicks? No, bubble is fine if stopPropagation is used on trigger.
                // Actually simple approach: click outside closes it.
            }

            function openFile(path) {
                // Show Editor UI
                const container = document.getElementById('editor-container');
                const title = document.getElementById('editor-filename');
                const unsaved = document.getElementById('editor-unsaved');
                const status = document.getElementById('editor-status');
                const btnEdit = document.getElementById('btn-edit-file');
                const btnSave = document.getElementById('btn-save-file');
                
                // Hide other main views
                document.getElementById('web-ui-container').classList.add('hidden');
                document.getElementById('web-ui-container').classList.remove('flex');
                document.getElementById('empty-state').style.display = 'none';
                document.querySelectorAll('.terminal-wrapper').forEach(el => el.classList.add('hidden'));
                
                container.classList.remove('hidden');
                container.classList.add('flex');
                
                // Ensure editor initialized
                if(!editor) initCodeEditor();
                
                // Reset State
                title.textContent = path;
                currentOpenFile = path;
                unsaved.classList.add('hidden');
                
                // Set Read-Only Mode by default
                editor.setReadOnly(true);
                editor.setValue("Loading...", -1);
                status.textContent = "Read Only";
                status.classList.remove('border-emerald-500', 'text-emerald-500');
                status.classList.add('border-zinc-700', 'text-zinc-500');
                
                // Show Edit button, Hide Save button
                btnEdit.classList.remove('hidden');
                btnSave.classList.add('hidden');

                fetch(`/api/fs/read?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(data => {
                     if(data.error) {
                         editor.setValue(`Error loading file: ${data.error}`, -1);
                         return;
                     }
                     // Detect mode
                     const mode = getModeFromPath(path);
                     editor.session.setMode(mode);
                     editor.setValue(data.content, -1); // -1 moves cursor to start
                     editor.clearSelection();
                })
                .catch(err => {
                    editor.setValue(`Failed to load file.`, -1);
                    console.error(err);
                });
                
                if(window.innerWidth < 768) {
                    closeSidePanel();
                }
            }
            
            function enableEditing() {
                if(!editor) return;
                editor.setReadOnly(false);
                
                const status = document.getElementById('editor-status');
                const btnEdit = document.getElementById('btn-edit-file');
                const btnSave = document.getElementById('btn-save-file');
                
                status.textContent = "Editing";
                status.classList.remove('border-zinc-700', 'text-zinc-500');
                status.classList.add('border-emerald-500', 'text-emerald-500');
                
                btnEdit.classList.add('hidden');
                btnSave.classList.remove('hidden');
                
                editor.focus();
            }

            function saveFile() {
                 if(!currentOpenFile || !editor) return;
                 
                 const content = editor.getValue();
                 
                 fetch('/api/fs/save', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ path: currentOpenFile, content: content })
                 })
                 .then(res => res.json())
                 .then(data => {
                     if(data.status === 'success') {
                         document.getElementById('editor-unsaved').classList.add('hidden');
                     } else {
                         alert('Error saving: ' + (data.error || 'Unknown error'));
                     }
                 })
                 .catch(err => {
                     alert('Failed to save file');
                     console.error(err);
                 });
            }

            function closeEditor() {
                document.getElementById('editor-container').classList.add('hidden');
                document.getElementById('editor-container').classList.remove('flex');
                currentOpenFile = null;
                goHome(); 
            }

            // Update toggleSidePanel to handle code-editor init
            const originalToggle = toggleSidePanel;
            toggleSidePanel = function(mode) {
                 originalToggle(mode);
                 if(mode === 'code-editor' && !document.getElementById('side-panel').classList.contains('w-0')) {
                     // Check if ace loaded, if not wait a bit or just init
                     if(typeof ace === 'undefined') {
                         setTimeout(initCodeEditor, 500);
                     } else {
                         initCodeEditor();
                     }
                 }
            }
            
            // Initialize UI State
            updateStartButtonUI();
            function addGenRow() {
                const container = document.getElementById('gen-rows-container');
                const rowId = 'row-' + Date.now();
                
                const div = document.createElement('div');
                div.className = 'gen-row grid grid-cols-12 gap-2 items-end animate-fade-in';
                div.id = rowId;
                
                div.innerHTML = `
                     <div class="col-span-7">
                         <input type="text" placeholder="https://huggingface.co/..." class="gen-url w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500">
                     </div>
                     <div class="col-span-4">
                         <select class="gen-dir w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500 font-mono">
                             <option value="checkpoints">checkpoints</option>
                             <option value="diffusion_models">diffusion_models</option>
                             <option value="vae">vae</option>
                             <option value="loras">loras</option>
                             <option value="text_encoders">text_encoders</option>
                             <option value="controlnet">controlnet</option>
                             <option value="upscale_models">upscale_models</option>
                             <option value="embeddings">embeddings</option>
                             <option value="clip">clip</option>
                             <option value="unet">unet</option>
                             <option value="clip_vision">clip_vision</option>
                         </select>
                     </div>
                     <div class="col-span-1 flex justify-center pb-0.5">
                          <button onclick="removeGenRow('${rowId}')" class="text-zinc-500 hover:text-red-400 transition-colors p-1">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                          </button>
                     </div>
                `;
                container.appendChild(div);
                
                // Auto scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            
            function removeGenRow(id) {
                const el = document.getElementById(id);
                if(el) el.remove();
            }
            
            async function generateRestoreScript() {
                const nameInput = document.getElementById('gen-script-name');
                const filename = nameInput.value.trim();
                
                if (!filename) {
                    alert('Please enter a script name');
                    return;
                }
                
                const rows = document.querySelectorAll('.gen-row');
                const items = [];
                
                rows.forEach(row => {
                    const urlVal = row.querySelector('.gen-url').value.trim();
                    const dirVal = row.querySelector('.gen-dir').value.trim();
                    
                    if (urlVal && dirVal) {
                        items.push({ url: urlVal, directory: dirVal });
                    }
                });
                
                if (items.length === 0) {
                    alert('Please add at least one valid row (URL and Directory)');
                    return;
                }
                
                try {
                    const response = await fetch('/api/restore-model/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename, items })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Success
                        alert(`Script ${data.filename} generated successfully!`);
                        
                        // Clear inputs
                        nameInput.value = '';
                        document.getElementById('gen-rows-container').innerHTML = `
                             <div class="gen-row grid grid-cols-12 gap-2 items-end">
                                 <div class="col-span-7">
                                     <label class="block text-[10px] font-medium text-zinc-500 mb-1">URL</label>
                                     <input type="text" placeholder="https://huggingface.co/..." class="gen-url w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500">
                                 </div>
                                 <div class="col-span-4">
                                     <label class="block text-[10px] font-medium text-zinc-500 mb-1">Diff Dir</label>
                                     <select class="gen-dir w-full bg-zinc-950/50 border border-zinc-700 rounded py-1.5 px-2 text-xs text-gray-300 focus:outline-none focus:border-emerald-500 font-mono">
                                         <option value="checkpoints">checkpoints</option>
                                         <option value="diffusion_models">diffusion_models</option>
                                         <option value="vae">vae</option>
                                         <option value="loras">loras</option>
                                         <option value="text_encoders">text_encoders</option>
                                         <option value="controlnet">controlnet</option>
                                         <option value="upscale_models">upscale_models</option>
                                         <option value="embeddings">embeddings</option>
                                         <option value="clip">clip</option>
                                         <option value="unet">unet</option>
                                         <option value="clip_vision">clip_vision</option>
                                     </select>
                                 </div>
                                 <div class="col-span-1 flex justify-center pb-1"></div>
                             </div>
                        `;
                        
                        // Refresh dropdown
                        if (typeof fetchRestoreImages === 'function') {
                            fetchRestoreImages();
                        } else {
                            // Fallback if that function isn't exposed (it should be part of openConfigModal logic)
                            // We might need to manually trigger logic or just ask user to reopen modal
                             const tab = document.getElementById('tab-btn-restore');
                             if(tab && tab.classList.contains('border-emerald-500')) {
                                 // Tab is active, maybe trigger reload?
                                 // But fetchRestoreImages is likely inside a closure or not defined globally
                                 // Let's assume user reopens modal or switches tabs for now if it fails
                             }
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                    
                } catch (error) {
                    console.error('Generate Error:', error);
                    alert('Failed to generate script');
                }
            }
    </script>

</body>

</html>